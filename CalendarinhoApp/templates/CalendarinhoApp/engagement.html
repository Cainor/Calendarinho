{% extends 'CalendarinhoApp/BaseNew.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% load my_tags %}


{% block head_block %}
<link href="{% static 'css/comments.css' %}" rel="stylesheet" type="text/css">
<!-- Inline Edit Styles -->
<link href="{% static 'css/inline-edit.css' %}" rel="stylesheet">
{% endblock %}


{% block body_block %}
<div class="container-fluid">
    <div class="row">
        <h1 class="h3 mb-2 text-title-color col-sm">
            <span class="inline-editable" 
                  data-model="engagement" 
                  data-field="name" 
                  data-id="{{eng.id}}"
                  data-type="text"
                  data-required="true"
                  data-max-length="200">{{eng.name}}</span> 
            - <a href="/projectManager/{{eng.project_manager.id}}">{{eng.project_manager}}</a>
        </h1>
        {% if 'jira.sitco.sa' in eng.JiraURL|lower %}
        <a href="{{eng.JiraURL}}" target="_blank">
            <input class="btn btn-info btn-md" style="margin-bottom: 35px; margin-right: 10px; background-color: #0d47a1;" type="button" value="Jira"></input>
        </a>
        {% endif %}
        <a href="/engagement/{{eng.id}}/Reports/">
            <input class="btn btn-primary btn-md" style="margin-bottom: 35px; margin-right: 10px;" type="button" value="Reports"></input>
        </a>
        <a href="/admin/CalendarinhoApp/engagement/{{eng.id}}/change/">
            <input class="btn btn-primary btn-md" style="margin-bottom: 35px; margin-right: 10px;" type="button" value="Edit"></input>
        </a>
    </div>
    <div class="row">
        <!-- Upcoming Engagement Card-->
        <div class="col-xl-4 col-lg-7">
            <div class="card shadow mb-4">
                <!-- Card Header - Dropdown -->
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Client</h6>
                </div>
                <!-- Card Body -->
                <div class="card-body">
                    <h4 align="center"><a href="/client/{{eng.client.id}}">{{eng.client}}</a></h4>
                </div>
            </div>
        </div>

        <!-- Upcoming Engagement Card-->
        <div class="col-xl-4 col-lg-7">
            <div class="card shadow mb-4">
                <!-- Card Header - Dropdown -->
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Engagement period</h6>
                </div>
                <!-- Card Body -->
                <div class="card-body">
                    <h4 align="center">
                        <span class="inline-editable" 
                              data-model="engagement" 
                              data-field="start_date" 
                              data-id="{{eng.id}}"
                              data-type="date"
                              data-value="{{eng.start_date|date:'Y-m-d'}}"
                              data-required="true">{{eng.start_date}}</span>
                        -
                        <span class="inline-editable" 
                              data-model="engagement" 
                              data-field="end_date" 
                              data-id="{{eng.id}}"
                              data-type="date"
                              data-value="{{eng.end_date|date:'Y-m-d'}}"
                              data-required="true">{{eng.end_date}}</span>
                    </h4>
                </div>
            </div>
        </div>


        <!-- Upcoming Engagement Card-->
        <div class="col-xl-4 col-lg-7">
            <div class="card shadow mb-4">
                <!-- Card Header - Dropdown -->
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Service Type</h6>
                </div>
                <!-- Card Body -->
                <div class="card-body">
                    <h4 align="center">
                        <span class="inline-editable" 
                              data-model="engagement" 
                              data-field="service_type" 
                              data-id="{{eng.id}}"
                              data-type="select"
                              data-max-length="100">{{eng.service_type}}</span>
                    </h4>
                </div>
            </div>
        </div>
    </div>

    
    <div class="row">
        <div class="col-xl-4 col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">Employees Involvment</h6>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="editEmployeeInvolvement({{eng.id}})" title="Edit employee involvement">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>Name</th>

                                </tr>
                            </thead>
                            <tbody>
                                {% for emp in eng.employees.all %}
                                <tr>
                                    <td><a href="/profile/{{emp.id}}">{{emp.first_name}} {{emp.last_name}}</a></td>


                                </tr>
                                {% endfor %}

                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
                <!-- Card Header - Dropdown -->
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Scope</h6>
                </div>
                <!-- Card Body -->
                <div class="card-body">
                    <div class="" style="height:10em;">
                        <div class="inline-editable" 
                             data-model="engagement" 
                             data-field="scope" 
                             data-id="{{eng.id}}"
                             data-type="textarea"
                             data-placeholder="Click to edit engagement scope (one domain/IP per line)..."
                             data-rows="8"
                             style="white-space: pre-line; min-height: 100px; cursor: pointer; padding: 10px; border: 1px dashed transparent; border-radius: 4px;"
                             onmouseover="this.style.borderColor='#007bff'"
                             onmouseout="this.style.borderColor='transparent'">{{eng.scope|default:"Click to add scope details..."}}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow mb-4">
        <!-- Card Header - Dropdown -->
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary">Comments Section</h6>
        </div>
        <!-- Card Body -->
        <div class="card-body">
                        <div class="row">
            <div class="col">
            <h5>Leave a comment</h5>
        </div>

            </div>
    
            
            <!-- Professional Mention System Styles -->
            <style>
                .mention-dropdown {
                    position: absolute;
                    background: white;
                    border: 1px solid #d1d5db;
                    border-radius: 6px;
                    max-height: 200px;
                    overflow-y: auto;
                    z-index: 1000;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    display: none;
                    min-width: 280px;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                }
                
                .mention-item {
                    padding: 10px 12px;
                    cursor: pointer;
                    border-bottom: 1px solid #f3f4f6;
                    transition: background-color 0.1s ease;
                    display: flex;
                    align-items: center;
                }
                
                .mention-item:hover, .mention-item.selected {
                    background-color: #f8f9fa;
                }
                
                .mention-item:last-child {
                    border-bottom: none;
                }
                
                .mention-user-info {
                    display: flex;
                    flex-direction: column;
                    flex: 1;
                }
                
                .mention-name {
                    font-weight: 500;
                    color: #374151;
                    font-size: 14px;
                    line-height: 1.2;
                }
                
                .mention-username {
                    font-size: 12px;
                    color: #6b7280;
                    margin-top: 1px;
                }
                
                .mention-everyone {
                    background-color: #fef2f2;
                    border-left: 3px solid #dc2626;
                }
                
                .mention-everyone .mention-name {
                    color: #dc2626;
                    font-weight: 600;
                }
                
                .mention-everyone .mention-username {
                    color: #b91c1c;
                }
                
                .mention-icon {
                    width: 28px;
                    height: 28px;
                    border-radius: 4px;
                    background: #e5e7eb;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: #6b7280;
                    font-weight: 500;
                    font-size: 11px;
                    margin-right: 10px;
                    flex-shrink: 0;
                }
                
                .mention-everyone .mention-icon {
                    background: #dc2626;
                    color: white;
                }
                
                /* mentioned-user class removed - now handled by template filter */
                
                .comment-form-container {
                    position: relative;
                }
                
                .mention-help-text {
                    font-size: 12px;
                    color: #6b7280;
                    margin-top: 4px;
                    margin-bottom: 0;
                }
                
                #id_body {
                    border-radius: 6px;
                    border: 1px solid #d1d5db;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                    min-height: 80px;
                    resize: vertical;
                }
                
                #id_body:focus {
                    border-color: var(--chartColor, #007bff);
                    box-shadow: 0 0 0 0.15rem rgba(0, 123, 255, 0.1);
                }
                
                .no-users-message {
                    padding: 12px 16px;
                    color: #6b7280;
                    font-size: 13px;
                    text-align: center;
                    font-style: italic;
                }
            </style>
            
            <div class="comment-form-container">
                <form method="post" style="margin-top: 1.3em;">
                    {{ comment_form | crispy }}
                    {% csrf_token %}
                    <p class="mention-help-text">Type @ to mention users or @everyone to notify all engagement members</p>
                    <button type="submit" class="btn btn-primary  btn-md">Submit</button>
                </form>
                <div id="mention-dropdown" class="mention-dropdown"></div>
            </div>
            
            <!-- Mention System JavaScript -->
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const textarea = document.getElementById('id_body');
                    const dropdown = document.getElementById('mention-dropdown');
                    let selectedIndex = -1;
                    let currentUsers = [];
                    let mentionStart = -1;
                    let searchTimeout = null;
                    let isSearching = false;
                    
                    if (!textarea || !dropdown) {
                        console.error('Mention system: Required elements not found');
                        return;
                    }
                    
                    // Set placeholder text
                    textarea.placeholder = 'Write your comment... Type @ to mention users or @everyone';
                    
                    // Position dropdown relative to textarea
                    function positionDropdown() {
                        const rect = textarea.getBoundingClientRect();
                        const containerRect = textarea.closest('.comment-form-container').getBoundingClientRect();
                        
                        dropdown.style.left = '0';
                        dropdown.style.top = (rect.bottom - containerRect.top + 5) + 'px';
                        dropdown.style.width = rect.width + 'px';
                    }
                    
                    // Show dropdown with users
                    function showDropdown(users) {
                        currentUsers = users;
                        selectedIndex = -1;
                        
                        dropdown.innerHTML = '';
                        
                        if (users.length === 0) {
                            const noUsersMessage = document.createElement('div');
                            noUsersMessage.className = 'no-users-message';
                            noUsersMessage.textContent = 'No users found';
                            dropdown.appendChild(noUsersMessage);
                            positionDropdown();
                            dropdown.style.display = 'block';
                            return;
                        }
                        
                        users.forEach((user, index) => {
                            const item = document.createElement('div');
                            item.className = 'mention-item';
                            item.dataset.index = index;
                            
                            if (user.is_special && user.id === 'everyone') {
                                item.classList.add('mention-everyone');
                                item.innerHTML = `
                                    <div class="mention-icon">@</div>
                                    <div class="mention-user-info">
                                        <span class="mention-name">${user.display_name}</span>
                                        <span class="mention-username">${user.full_name}</span>
                                    </div>
                                `;
                            } else {
                                const initials = user.display_name.split(' ').map(n => n[0]).join('').toUpperCase();
                                item.innerHTML = `
                                    <div class="mention-icon">${initials}</div>
                                    <div class="mention-user-info">
                                        <span class="mention-name">${user.display_name}</span>
                                        <span class="mention-username">@${user.username}</span>
                                    </div>
                                `;
                            }
                            
                            item.addEventListener('click', function() {
                                selectUser(index);
                            });
                            
                            dropdown.appendChild(item);
                        });
                        
                        positionDropdown();
                        dropdown.style.display = 'block';
                    }
                    
                    // Hide dropdown
                    function hideDropdown() {
                        dropdown.style.display = 'none';
                        selectedIndex = -1;
                        currentUsers = [];
                        mentionStart = -1;
                    }
                    
                    // Update selection highlight
                    function updateSelection() {
                        const items = dropdown.querySelectorAll('.mention-item');
                        items.forEach((item, index) => {
                            if (index === selectedIndex) {
                                item.classList.add('selected');
                                // Scroll into view if needed
                                item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                            } else {
                                item.classList.remove('selected');
                            }
                        });
                    }
                    
                    // Select a user and insert into textarea
                    function selectUser(index) {
                        if (index < 0 || index >= currentUsers.length || mentionStart === -1) {
                            return;
                        }
                        
                        const user = currentUsers[index];
                        let mention;
                        
                        if (user.is_special && user.id === 'everyone') {
                            mention = '@everyone ';
                        } else {
                            // Use quotes for multi-word display names
                            const displayName = user.display_name;
                            if (displayName.includes(' ')) {
                                mention = `@"${displayName}" `;
                            } else {
                                mention = `@${displayName} `;
                            }
                        }
                        
                        const currentValue = textarea.value;
                        const beforeMention = currentValue.substring(0, mentionStart);
                        const afterCursor = currentValue.substring(textarea.selectionEnd);
                        
                        textarea.value = beforeMention + mention + afterCursor;
                        
                        const newCursorPos = beforeMention.length + mention.length;
                        textarea.setSelectionRange(newCursorPos, newCursorPos);
                        textarea.focus();
                        
                        hideDropdown();
                    }
                    
                    // Debounced search for users
                    async function searchUsers(query) {
                        try {
                            isSearching = true;
                            const engagementId = {{ eng.id }};
                            const url = `/api/engagement/${engagementId}/search-users/?q=${encodeURIComponent(query)}`;
                            
                            const controller = new AbortController();
                            const timeoutId = setTimeout(() => controller.abort(), 5000);
                            
                            const response = await fetch(url, {
                                signal: controller.signal,
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest',
                                    'Content-Type': 'application/json'
                                }
                            });
                            
                            clearTimeout(timeoutId);
                            
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            
                            const data = await response.json();
                            return data.users || [];
                        } catch (error) {
                            if (error.name === 'AbortError') {
                                console.log('Search request aborted');
                            } else {
                                console.error('Error searching users:', error);
                            }
                            return [];
                        } finally {
                            isSearching = false;
                        }
                    }
                    
                    // Debounced search wrapper
                    function debouncedSearch(query, callback) {
                        if (searchTimeout) {
                            clearTimeout(searchTimeout);
                        }
                        
                        searchTimeout = setTimeout(async () => {
                            const users = await searchUsers(query);
                            callback(users);
                        }, 300);
                    }
                    
                    // Handle textarea input
                    textarea.addEventListener('input', async function(e) {
                        const cursorPos = textarea.selectionStart;
                        const textBeforeCursor = textarea.value.substring(0, cursorPos);
                        
                        // Find the last @ symbol before cursor
                        const lastAtIndex = textBeforeCursor.lastIndexOf('@');
                        
                        if (lastAtIndex === -1) {
                            hideDropdown();
                            return;
                        }
                        
                        // Check if there's whitespace between @ and cursor
                        const textAfterAt = textBeforeCursor.substring(lastAtIndex + 1);
                        if (textAfterAt.includes(' ') || textAfterAt.includes('\n')) {
                            hideDropdown();
                            return;
                        }
                        
                        // Check if @ is at start or preceded by whitespace
                        const charBeforeAt = lastAtIndex > 0 ? textBeforeCursor[lastAtIndex - 1] : ' ';
                        if (charBeforeAt !== ' ' && charBeforeAt !== '\n' && lastAtIndex !== 0) {
                            hideDropdown();
                            return;
                        }
                        
                        mentionStart = lastAtIndex;
                        const query = textAfterAt;
                        
                        // Always search immediately when @ is typed, even with empty query
                        if (query.length === 0) {
                            // Show all users immediately when @ is typed
                            const users = await searchUsers('');
                            showDropdown(users);
                        } else {
                            // For non-empty queries, use debounced search
                            debouncedSearch(query, (users) => {
                                if (mentionStart !== -1) { // Only show if mention is still active
                                    showDropdown(users);
                                }
                            });
                        }
                    });
                    
                    // Handle keyboard navigation
                    textarea.addEventListener('keydown', function(e) {
                        if (dropdown.style.display !== 'block') {
                            return;
                        }
                        
                        switch (e.key) {
                            case 'ArrowDown':
                                e.preventDefault();
                                if (selectedIndex < 0) {
                                    selectedIndex = 0;
                                } else {
                                    selectedIndex = Math.min(selectedIndex + 1, currentUsers.length - 1);
                                }
                                updateSelection();
                                break;
                                
                            case 'ArrowUp':
                                e.preventDefault();
                                if (selectedIndex < 0) {
                                    selectedIndex = currentUsers.length - 1;
                                } else {
                                    selectedIndex = Math.max(selectedIndex - 1, 0);
                                }
                                updateSelection();
                                break;
                                
                            case 'Enter':
                            case 'Tab':
                                if (selectedIndex >= 0) {
                                    e.preventDefault();
                                    selectUser(selectedIndex);
                                }
                                break;
                                
                            case 'Escape':
                                e.preventDefault();
                                hideDropdown();
                                break;
                        }
                    });
                    
                    // Hide dropdown when clicking outside or on blur
                    document.addEventListener('click', function(e) {
                        if (!textarea.contains(e.target) && !dropdown.contains(e.target)) {
                            hideDropdown();
                        }
                    });
                    
                    // Handle textarea blur with delay to allow dropdown clicks
                    textarea.addEventListener('blur', function() {
                        setTimeout(() => {
                            if (!dropdown.matches(':hover')) {
                                hideDropdown();
                            }
                        }, 150);
                    });
                    
                    // Reposition dropdown on window resize
                    window.addEventListener('resize', function() {
                        if (dropdown.style.display === 'block') {
                            positionDropdown();
                        }
                    });
                    
                    // Note: Mention rendering is now handled by Django template filter
                    const observer = new MutationObserver(function(mutations) {
                        mutations.forEach(function(mutation) {
                            if (mutation.type === 'childList') {
                                mutation.addedNodes.forEach(function(node) {
                                    if (node.nodeType === 1 && (node.classList.contains('comment_body') || node.querySelector('.comment_body'))) {
                                        highlightMentionsInComments();
                                    }
                                });
                            }
                        });
                    });
                    
                    // Observe the comments container for new comments
                    const commentsContainer = document.querySelector('.comments-container, .comment-list, .comments');
                    if (commentsContainer) {
                        observer.observe(commentsContainer, { childList: true, subtree: true });
                    }
                    
                    // Professional mention interactivity (removed playful effects)
                    function initializeMentionInteractivity() {
                        const mentions = document.querySelectorAll('.mention');
                        
                        mentions.forEach(mention => {
                            // Skip if already initialized
                            if (mention.dataset.initialized) return;
                            
                            // Add basic tooltip content
                            const mentionType = mention.dataset.mentionType;
                            const userName = mention.dataset.userName;
                            
                            let tooltipText = '';
                            if (mentionType === 'everyone') {
                                tooltipText = 'This mention notifies all engagement members';
                            } else if (userName) {
                                tooltipText = `${userName} - Click to view profile`;
                            }
                            
                            // Create and append tooltip
                            if (tooltipText) {
                                const tooltip = document.createElement('div');
                                tooltip.className = 'mention-tooltip';
                                tooltip.textContent = tooltipText;
                                tooltip.setAttribute('role', 'tooltip');
                                mention.appendChild(tooltip);
                            }
                            
                            // Add click handler for user mentions
                            if (mentionType === 'user' && userName) {
                                mention.style.cursor = 'pointer';
                                mention.addEventListener('click', (e) => {
                                    e.preventDefault();
                                    // Simple professional feedback
                                    mention.style.opacity = '0.7';
                                    setTimeout(() => {
                                        mention.style.opacity = '';
                                    }, 100);
                                    
                                    // In a real app, this would navigate to user profile
                                    console.log(`Navigate to profile for: ${userName}`);
                                    // window.location.href = `/profile/${userName}`;
                                });
                            }
                            
                            // Mark as initialized
                            mention.dataset.initialized = 'true';
                        });
                    }
                    
                    // Initialize mention interactivity on page load
                    initializeMentionInteractivity();
                });
            </script>
            {% for comment in comments %}
            <div class="comment_body mt-2 bg-light text-dark border border-primary ">
                <div class="comment_font" id="comment-{{ comment.id }}">{{comment.body|render_mentions}}</div>
                <div class="row comment_icons bg-primary">
                    <i class="fa fa-calendar-alt mr-1"></i><span class="mr-3">{{comment.created_on | date}}</span>
                    <i class="fa fa-pencil-alt mr-1"></i><a href="/profile/{{comment.user.id}}" style="color: inherit;"
                        class="mr-3">{{comment.user.first_name}} {{comment.user.last_name}}</a>
                    {%if comment.user == request.user or user.user_type == "M"%}
                    <i class="fa fa-trash-alt mr-1"></i><a href="/DeleteComment/{{comment.id}}" style="color: inherit;"
                        class="mr-3">Delete</a>
                    {%endif%}
                </div>
            </div>

            {% endfor %}
        </div>
    </div>
</div>

<!-- Simple Inline Edit JavaScript for testing -->
<script src="{% static 'js/simple-inline-edit.js' %}"></script>

<script>
// Engagement page specific inline edit handlers
function waitForInlineEditor(callback, attempts = 0) {
    if (window.inlineEditor && window.inlineEditor.setupEventListeners) {
        console.log('Inline editor found and ready');
        callback();
    } else if (attempts < 50) { // Try for 5 seconds
        console.log('Waiting for inline editor... attempt', attempts + 1);
        setTimeout(() => waitForInlineEditor(callback, attempts + 1), 100);
    } else {
        console.error('Timeout waiting for inline editor');
        console.log('Available objects:', {
            inlineEditor: window.inlineEditor,
            InlineEditor: window.InlineEditor
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    waitForInlineEditor(function() {
        console.log('Setting up engagement page inline editing');
        
        // Add custom event listeners for engagement updates
        document.addEventListener('inlineEditSuccess', function(e) {
            const detail = e.detail;
            console.log('Field updated successfully:', detail);
            
            // If start_date or end_date was updated, we might want to refresh certain elements
            if (detail.field === 'start_date' || detail.field === 'end_date') {
                console.log('Date field updated');
            }
        });
        
        document.addEventListener('inlineEditError', function(e) {
            console.error('Error updating field:', e.detail);
        });
        
        // Test service_type field specifically
        const serviceField = document.querySelector('[data-field="service_type"]');
        if (serviceField) {
            console.log('Service type field found:', serviceField);
            console.log('Field classes:', serviceField.className);
            console.log('Field data attributes:', serviceField.dataset);
        } else {
            console.warn('Service type field not found');
        }
    });
});

// Function to edit employee involvement
function editEmployeeInvolvement(engagementId) {
    // Create and show employee management modal
    showEmployeeManagementModal(engagementId);
}

// Employee Management Modal
async function showEmployeeManagementModal(engagementId) {
    // Set current engagement ID and reset pending changes
    currentEngagementId = engagementId;
    pendingChanges = {additions: [], removals: []};
    // Create modal HTML
    const modalHtml = `
        <div class="modal fade" id="employeeModal" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Manage Employee Involvement</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div id="employeeManagementContent">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                                <p class="mt-2">Loading employees...</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <div id="changesIndicator" class="mr-auto" style="display: none;">
                            <small class="text-info">
                                <i class="fas fa-info-circle"></i>
                                <span id="changesText">No changes</span>
                            </small>
                        </div>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-success" id="confirmChangesBtn" onclick="confirmEmployeeChanges()" disabled>
                            <i class="fas fa-check"></i> Confirm Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('employeeModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    $('#employeeModal').modal('show');
    
    // Load employee data
    await loadEmployeeManagementContent(engagementId);
}

async function loadEmployeeManagementContent(engagementId) {
    try {
        console.log('Loading employee data for engagement:', engagementId);
        
        // Load current employees and available employees
        const [currentResponse, availableResponse] = await Promise.all([
            fetch(`/api/engagement/${engagementId}/employees/`, {
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            }),
            fetch(`/api/employees/available/?engagement_id=${engagementId}`, {
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
        ]);
        
        console.log('Current employees response status:', currentResponse.status);
        console.log('Available employees response status:', availableResponse.status);
        
        const currentData = await currentResponse.json();
        const availableData = await availableResponse.json();
        
        console.log('Current employees data:', currentData);
        console.log('Available employees data:', availableData);
        
        if (currentData.success && availableData.success) {
            // Extract the actual arrays from the nested data structure
            const currentEmployees = currentData.data.employees || currentData.data || [];
            const availableEmployees = availableData.data.employees || availableData.data || [];
            
            console.log('Extracted current employees:', currentEmployees);
            console.log('Extracted available employees:', availableEmployees);
            
            renderEmployeeManagementInterface(engagementId, currentEmployees, availableEmployees);
        } else {
            const errorMsg = `Current: ${currentData.message || 'Unknown error'}, Available: ${availableData.message || 'Unknown error'}`;
            throw new Error(errorMsg);
        }
    } catch (error) {
        console.error('Error loading employees:', error);
        document.getElementById('employeeManagementContent').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i>
                Error loading employee data: ${error.message}
                <br><small>Check console for details. You may need manager permissions.</small>
            </div>
        `;
    }
}

function renderEmployeeManagementInterface(engagementId, currentEmployees, availableEmployees) {
    const content = document.getElementById('employeeManagementContent');
    
    // Filter available employees to exclude current ones
    const currentEmployeeIds = currentEmployees.map(emp => emp.id);
    const filteredAvailable = availableEmployees.filter(emp => !currentEmployeeIds.includes(emp.id));
    
    const html = `
        <div class="row">
            <div class="col-md-6">
                <h6 class="font-weight-bold text-primary">Current Team Members</h6>
                <div class="border rounded p-3" style="min-height: 300px; max-height: 300px; overflow-y: auto;">
                    ${currentEmployees.length === 0 ? 
                        '<p class="text-muted text-center mt-3">No team members assigned</p>' :
                        currentEmployees.map(emp => `
                            <div class="d-flex justify-content-between align-items-center py-2 border-bottom" id="current-emp-${emp.id}">
                                <div>
                                    <strong>${emp.first_name} ${emp.last_name}</strong>
                                    <br><small class="text-muted">${emp.user_type || 'Employee'}</small>
                                </div>
                                <button type="button" class="btn btn-outline-danger btn-sm" 
                                        onclick="markEmployeeForRemoval(${engagementId}, ${emp.id}, '${emp.first_name} ${emp.last_name}')"
                                        title="Remove from engagement">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `).join('')
                    }
                </div>
            </div>
            
            <div class="col-md-6">
                <h6 class="font-weight-bold text-success">Available Employees</h6>
                <div class="border rounded p-3" style="min-height: 300px; max-height: 300px; overflow-y: auto;">
                    ${filteredAvailable.length === 0 ? 
                        '<p class="text-muted text-center mt-3">No additional employees available</p>' :
                        filteredAvailable.map(emp => {
                            // Determine availability styling
                            let availabilityClass = 'text-success';
                            let availabilityIcon = 'fas fa-check-circle';
                            let availabilityText = 'Available';
                            
                            if (emp.availability) {
                                if (emp.availability.is_completely_busy) {
                                    availabilityClass = 'text-danger';
                                    availabilityIcon = 'fas fa-times-circle';
                                    availabilityText = 'Fully Booked';
                                } else if (emp.availability.is_partially_available) {
                                    availabilityClass = 'text-warning';
                                    availabilityIcon = 'fas fa-exclamation-triangle';
                                    availabilityText = emp.availability_text;
                                }
                            }
                            
                            return `
                                <div class="d-flex justify-content-between align-items-center py-2 border-bottom" id="available-emp-${emp.id}">
                                    <div>
                                        <strong>${emp.first_name} ${emp.last_name}</strong>
                                        <br><small class="text-muted">${emp.user_type || 'Employee'}</small>
                                        ${emp.availability ? 
                                            `<br><small class="${availabilityClass}">
                                                <i class="${availabilityIcon}"></i> ${availabilityText}
                                                ${emp.availability.busy_days > 0 ? `<br><span class="text-muted">${emp.busy_days_text}</span>` : ''}
                                            </small>` : 
                                            emp.current_engagements.length > 0 ? 
                                                `<br><small class="text-warning">Currently on ${emp.current_engagements.length} engagement(s)</small>` : 
                                                ''
                                        }
                                    </div>
                                    <button type="button" class="btn btn-outline-success btn-sm" 
                                            onclick="markEmployeeForAddition(${engagementId}, ${emp.id}, '${emp.first_name} ${emp.last_name}')"
                                            title="Add to engagement">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            `;
                        }).join('')
                    }
                </div>
            </div>
        </div>
    `;
    
    content.innerHTML = html;
}

// Track pending changes
let pendingChanges = {
    additions: [], // {id, name}
    removals: []   // {id, name}
};

function markEmployeeForAddition(engagementId, employeeId, employeeName) {
    // Check if already in removals (undo removal)
    const removalIndex = pendingChanges.removals.findIndex(emp => emp.id === employeeId);
    if (removalIndex !== -1) {
        pendingChanges.removals.splice(removalIndex, 1);
    } else {
        // Add to additions if not already there
        if (!pendingChanges.additions.find(emp => emp.id === employeeId)) {
            pendingChanges.additions.push({id: employeeId, name: employeeName});
        }
    }
    
    updateUIForPendingChanges();
    updateChangesDisplay();
}

function markEmployeeForRemoval(engagementId, employeeId, employeeName) {
    // Check if already in additions (undo addition)
    const additionIndex = pendingChanges.additions.findIndex(emp => emp.id === employeeId);
    if (additionIndex !== -1) {
        pendingChanges.additions.splice(additionIndex, 1);
    } else {
        // Add to removals if not already there
        if (!pendingChanges.removals.find(emp => emp.id === employeeId)) {
            pendingChanges.removals.push({id: employeeId, name: employeeName});
        }
    }
    
    updateUIForPendingChanges();
    updateChangesDisplay();
}

function updateUIForPendingChanges() {
    // Update visual indicators for additions
    pendingChanges.additions.forEach(emp => {
        const element = document.getElementById(`available-emp-${emp.id}`);
        if (element) {
            element.style.backgroundColor = '#d4edda';
            element.style.border = '2px solid #28a745';
            const button = element.querySelector('button');
            button.innerHTML = '<i class="fas fa-check"></i>';
            button.className = 'btn btn-success btn-sm';
            button.title = 'Will be added';
        }
    });
    
    // Update visual indicators for removals
    pendingChanges.removals.forEach(emp => {
        const element = document.getElementById(`current-emp-${emp.id}`);
        if (element) {
            element.style.backgroundColor = '#f8d7da';
            element.style.border = '2px solid #dc3545';
            const button = element.querySelector('button');
            button.innerHTML = '<i class="fas fa-check"></i>';
            button.className = 'btn btn-danger btn-sm';
            button.title = 'Will be removed';
        }
    });
    
    // Reset elements not in pending changes
    document.querySelectorAll('[id^="available-emp-"], [id^="current-emp-"]').forEach(element => {
        const empId = parseInt(element.id.split('-')[2]);
        const isAddition = pendingChanges.additions.find(emp => emp.id === empId);
        const isRemoval = pendingChanges.removals.find(emp => emp.id === empId);
        
        if (!isAddition && !isRemoval) {
            element.style.backgroundColor = '';
            element.style.border = '';
            const button = element.querySelector('button');
            if (element.id.startsWith('available-emp-')) {
                button.innerHTML = '<i class="fas fa-plus"></i>';
                button.className = 'btn btn-outline-success btn-sm';
                button.title = 'Add to engagement';
            } else {
                button.innerHTML = '<i class="fas fa-times"></i>';
                button.className = 'btn btn-outline-danger btn-sm';
                button.title = 'Remove from engagement';
            }
        }
    });
}

function updateChangesDisplay() {
    const changesIndicator = document.getElementById('changesIndicator');
    const changesText = document.getElementById('changesText');
    const confirmBtn = document.getElementById('confirmChangesBtn');
    
    const totalChanges = pendingChanges.additions.length + pendingChanges.removals.length;
    
    if (totalChanges === 0) {
        changesIndicator.style.display = 'none';
        confirmBtn.disabled = true;
        changesText.textContent = 'No changes';
    } else {
        changesIndicator.style.display = 'block';
        confirmBtn.disabled = false;
        
        let changeText = [];
        if (pendingChanges.additions.length > 0) {
            changeText.push(`${pendingChanges.additions.length} to add`);
        }
        if (pendingChanges.removals.length > 0) {
            changeText.push(`${pendingChanges.removals.length} to remove`);
        }
        
        changesText.textContent = changeText.join(', ');
    }
}

async function confirmEmployeeChanges() {
    const confirmBtn = document.getElementById('confirmChangesBtn');
    const originalText = confirmBtn.innerHTML;
    
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    confirmBtn.disabled = true;
    
    try {
        let allSuccessful = true;
        const results = [];
        
        // Process additions
        for (const emp of pendingChanges.additions) {
            try {
                const response = await fetch(`/api/engagement/${currentEngagementId}/add-employee/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        employee_id: emp.id
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    results.push(`✓ ${emp.name} added`);
                } else {
                    results.push(`✗ Failed to add ${emp.name}: ${data.message}`);
                    allSuccessful = false;
                }
            } catch (error) {
                results.push(`✗ Error adding ${emp.name}`);
                allSuccessful = false;
            }
        }
        
        // Process removals
        for (const emp of pendingChanges.removals) {
            try {
                const response = await fetch(`/api/engagement/${currentEngagementId}/remove-employee/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        employee_id: emp.id
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    results.push(`✓ ${emp.name} removed`);
                } else {
                    results.push(`✗ Failed to remove ${emp.name}: ${data.message}`);
                    allSuccessful = false;
                }
            } catch (error) {
                results.push(`✗ Error removing ${emp.name}`);
                allSuccessful = false;
            }
        }
        
        // Show results
        const resultType = allSuccessful ? 'success' : 'warning';
        const resultMessage = results.join('<br>');
        showNotification(resultMessage, resultType);
        
        // Reset pending changes
        pendingChanges = {additions: [], removals: []};
        
        // Close modal and refresh page
        $('#employeeModal').modal('hide');
        setTimeout(() => location.reload(), 1000);
        
    } catch (error) {
        showNotification('Error processing changes', 'error');
    } finally {
        confirmBtn.innerHTML = originalText;
        confirmBtn.disabled = false;
    }
}

// Store current engagement ID for use in confirm function
let currentEngagementId = null;

function showNotification(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const icon = type === 'success' ? 'check-circle' : 'exclamation-triangle';
    
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show`;
    notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        <i class="fas fa-${icon} mr-2"></i>
        ${message}
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}
</script>
{% endblock %}