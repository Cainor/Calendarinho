{% extends 'CalendarinhoApp/BaseNew.html' %}
{% load static %}
{% load crispy_forms_tags %}




{% block head_block %}
{% endblock %}

{% block body_block %}
<div class="container-fluid">
  <div class="row">
    <h1 class="h3 mb-2 text-title-color col-sm">Reports for {{engagement}}</h1>
    <a href="/engagement/{{engagement.id}}">
      <input class="btn btn-primary btn-md" style="margin-bottom: 35px; margin-right: 10px;" type="button" value="Back"></input>
    </a>
  </div>
  <div class="row">
  <!-- Integrated Report Upload with Vulnerability Counts -->
        <div class="col-12">
            <div class="card shadow mb-4">
                <!-- Card Header -->
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-upload mr-2"></i>Upload Report with Vulnerability Counts
                    </h6>
                </div>
                <!-- Card Body -->
                <div class="card-body">
                    {% csrf_token %}
                    {% crispy form form.helper %}
                    {% if error %}
                    <p class="text-danger">{{ error }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
  </div>
  {% if list %}
  <!-- Vulnerability Summary Card -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow">
        <div class="card-header py-3">
          <h6 class="m-0 font-weight-bold text-primary">
            <i class="fas fa-chart-pie mr-2"></i>Vulnerability Summary for {{engagement}}
          </h6>
        </div>
        <div class="card-body">
          {% with eng_summary=engagement.get_vulnerability_summary %}
            <div class="row">
              <div class="col-md-3 text-center">
                <div class="border border-danger rounded p-3">
                  <h4 class="text-danger font-weight-bold">{{eng_summary.critical_open}}</h4>
                  <p class="text-muted mb-0">Critical Open</p>
                  <small class="text-success">Fixed: {{eng_summary.critical_fixed}}</small>
                </div>
              </div>
              <div class="col-md-3 text-center">
                <div class="border border-warning rounded p-3">
                  <h4 class="text-warning font-weight-bold">{{eng_summary.high_open}}</h4>
                  <p class="text-muted mb-0">High Open</p>
                  <small class="text-success">Fixed: {{eng_summary.high_fixed}}</small>
                </div>
              </div>
              <div class="col-md-3 text-center">
                <div class="border border-info rounded p-3">
                  <h4 class="text-info font-weight-bold">{{eng_summary.medium_open}}</h4>
                  <p class="text-muted mb-0">Medium Open</p>
                  <small class="text-success">Fixed: {{eng_summary.medium_fixed}}</small>
                </div>
              </div>
              <div class="col-md-3 text-center">
                <div class="border border-success rounded p-3">
                  <h4 class="text-success font-weight-bold">{{eng_summary.low_open}}</h4>
                  <p class="text-muted mb-0">Low Open</p>
                  <small class="text-success">Fixed: {{eng_summary.low_fixed}}</small>
                </div>
              </div>
            </div>
            <div class="row mt-3">
              <div class="col-md-6">
                <div class="alert alert-danger">
                  <i class="fas fa-exclamation-triangle mr-2"></i>
                  <strong>Total Open: {{eng_summary.total_open}}</strong>
                </div>
              </div>
              <div class="col-md-6">
                <div class="alert alert-success">
                  <i class="fas fa-check-circle mr-2"></i>
                  <strong>Total Fixed: {{eng_summary.total_fixed}}</strong>
                </div>
              </div>
            </div>
          {% endwith %}
        </div>
      </div>
    </div>
  </div>

  <div class="row">
  <!-- File List Card-->
        <div class="col">
            <div class="card shadow mb-4">
                <!-- Card Header - Dropdown -->
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">List of Files</h6>
                </div>
                <!-- Card Body -->
                <div class="card-body">
                <link rel="stylesheet" href="{% static 'css/fnon.min.css' %}" />
                <script src="{% static 'js/fnon.min.js' %}"></script>
                <table class="table table-bordered sortable" id="dataTable" width="100%" cellspacing="0">
                    <thead class="thead-light">
                      <tr>
                      <th style="text-align:center">Note</th>
                      <th style="text-align:center">Type</th>
                      <th style="text-align:center">Uploaded By</th>
                      <th style="text-align:center">Timestamp</th>
                      <th style="text-align:center">Download</th>
                      <th style="text-align:center">Delete</th>
                      </tr>
                    </thead>
                    <tbody class="table-hover">
                  {% for file in list%}
                  
                      <tr>
                      <td>{{file.note}}</td>
                      <td>{{file.report_type}}</td>
                      <td>{{file.user}}</td>
                      <td>{{file.timestamp}}</td>
                      <td align="center"><a href="/download/{{ file.reference }}"><button class="btn btn-primary btn-md"><i class="fas fa-download"></i></button></a></td>
                      {% if user == file.user or user.is_superuser%}
                        <td align="center"><button id="delete_btn" class="btn btn-danger btn-md" onclick="DeleteConfirmation('{{ file.reference }}')"><i class="fas fa-trash-alt"></i></button></td>
                      {% else %}
                        <td align="center"><button id="delete_btn" class="btn btn-secondary btn-md" disabled><i class="fas fa-trash-alt"></i></button></td>
                      {% endif %}
                      </tr>
                    
                  {% endfor %}
                      </tbody>
                  </table>
                </div>         
                <script>
                  function DeleteConfirmation(uuid){
                    Fnon.Ask.Dark({
                    title:'Confirmation',
                    message:'Are you sure you want to delete this report?',
                    callback:(result)=>{
                      if(result){
                        document.location = "/delete/"+uuid
                      }
                      }
                    });
                    }
                </script>  
            </div>
        </div>
  </div>
  {% else %}
  <div class="row">
  <p class="col" align="center"><i>There is no uploaded reports for this engagement.</i></p>
  </div>
  {% endif %}
</div>
{% endblock %}