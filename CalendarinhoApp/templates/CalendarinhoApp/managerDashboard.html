{% extends 'CalendarinhoApp/BaseNew.html' %}
{% load static %}



{% block head_block %}
<!-- Page level plugins -->
<script src="{% static 'vendor/chart.js/Chart.min.js' %}"></script>
{% endblock %}


{% block body_block %}


{% comment %} Search Settings {% endcomment %}

<div class="container-fluid">
    <!-- Page Heading -->
    <div style="display: flex; justify-content: space-between">
        <div>
            <h1 class="h3 mb-0 text-title-color">Manager Dashboard</h1>
            <i>(default settings shows past 3 months)</i>
        </div>
        <div>
            <form action="/managerDashboard" method="POST" id="dashboardForm" onsubmit="return validateDateRange(event)">
                <div style="display: flex; flex-direction: row; justify-content: space-between; gap: 6px; font-weight: bold; font-size: 19px; font-variant-position: sub; white-space: nowrap;">
                    {{form}}
                    <div style="display: flex;justify-content: flex-end;flex-direction: column;">
                    {% csrf_token %}
                    <button type="submit" id="updateButton" class="update-btn">
                        <i class="fas fa-sync-alt btn-icon"></i>
                        <span class="btn-text">Update</span>
                    </button>
                    </div>
                </div>
                <div id="dateError" class="date-error-message" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Start date cannot be after end date. Please check your date selection.</span>
                </div>
            </form>
        </div>
    </div>
    <br>

    <!-- Clean Metrics Row -->
    <div class="row mb-4">
        <!-- Working Days -->
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="metric-card">
                <div class="d-flex align-items-center">
                    <div class="metric-icon">
                        <i class="fas fa-calendar-day"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value">{{allEmpDays}}</div>
                        <div class="metric-label">Total Working Days</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Clients Served This Period -->
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="metric-card">
                <div class="d-flex align-items-center">
                    <div class="icon-wrapper" style="background: linear-gradient(135deg, #0ea5e9 0%, #10b981 100%); box-shadow: 0 4px 15px rgba(14, 165, 233, 0.2);">
                        <i class="fas fa-handshake text-white"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value">{{total_unique_clients_served|default:0}}</div>
                        <div class="metric-label">Clients Served This Period</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Services Completed -->
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="metric-card clickable-card" onclick="showCompletedServicesModal()" style="cursor: pointer;">
                <div class="d-flex align-items-center">
                    <div class="metric-icon services">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value">{{total_services|default:0}}</div>
                        <div class="metric-label">
                            Services Completed
                            <i class="fas fa-external-link-alt ml-2" style="font-size: 0.8em; color: #718096;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Findings -->
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="metric-card">
                <div class="d-flex align-items-center">
                    <div class="icon-wrapper" style="background: linear-gradient(135deg, #dc2626 0%, #f59e0b 100%); box-shadow: 0 4px 15px rgba(220, 38, 38, 0.2);">
                        <i class="fas fa-exclamation-triangle text-white"></i>
                    </div>
                    <div class="metric-content">
                        <div class="metric-value">{{total_vulnerabilities_found|default:0}}</div>
                        <div class="metric-label">Total Findings</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Management Action Cards -->
    <div class="row mb-4">
        <!-- Team Performance Summary -->
        <div class="col-xl-6 col-lg-12 mb-4">
            <div class="card shadow">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Team Performance Summary</h6>
                    <i class="fas fa-users"></i>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="text-center">
                                <h3 class="text-success">{{utilization_distribution.optimal|default:0}}</h3>
                                <p class="text-muted">Optimal (30-80%)</p>
                                <button class="btn btn-sm btn-outline-success" type="button" onclick="toggleEmployeeDetails('optimalEmployees', this)">
                                    <i class="fas fa-plus"></i> Show Details
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <h3 class="text-warning">{{utilization_distribution.under|default:underutilized_count|default:0}}</h3>
                                <p class="text-muted">Under-utilized (<30%)</p>
                                <button class="btn btn-sm btn-outline-warning" type="button" onclick="toggleEmployeeDetails('underutilizedEmployees', this)">
                                    <i class="fas fa-plus"></i> Show Details
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <h3 class="text-danger">{{utilization_distribution.over|default:0}}</h3>
                                <p class="text-muted">Over-utilized (>80%)</p>
                                <button class="btn btn-sm btn-outline-danger" type="button" onclick="toggleEmployeeDetails('overutilizedEmployees', this)">
                                    <i class="fas fa-plus"></i> Show Details
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Collapsible Employee Lists -->
                    <div class="collapse mt-3" id="optimalEmployees" style="display: none;">
                        <div class="card card-body bg-light">
                            <h6 class="text-success"><i class="fas fa-users"></i> Optimal Utilization Employees</h6>
                            <div class="col">
                                {% for emp in empsNumDays %}
                                    {% if emp|length >= 4 %}
                                        {% comment %}Enhanced format with utilization data{% endcomment %}
                                        {% with days=emp.1 utilization=emp.2 status=emp.3 %}
                                            {% if status == 'optimal' %}
                                            <div class="col-md-6 mb-2">
                                                <div class="d-flex justify-content-between">
                                                    <span>{{emp.0.first_name}} {{emp.0.last_name}}</span>
                                                    <span class="badge bg-success text-white">{{days}} days ({{utilization}}%)</span>
                                                </div>
                                            </div>
                                            {% endif %}
                                        {% endwith %}
                                    {% else %}
                                        {% comment %}Legacy format fallback{% endcomment %}
                                        {% with days=emp.1 %}
                                            {% if days >= 20 and days <= 60 %}
                                            <div class="col-md-6 mb-2">
                                                <div class="d-flex justify-content-between">
                                                    <span>{{emp.0.first_name}} {{emp.0.last_name}}</span>
                                                    <span class="badge bg-success">{{days}} days</span>
                                                </div>
                                            </div>
                                            {% endif %}
                                        {% endwith %}
                                    {% endif %}
                                {% empty %}
                                <p class="text-muted">No employees in optimal range</p>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="collapse mt-3" id="underutilizedEmployees" style="display: none;">
                        <div class="card card-body bg-light">
                            <h6 class="text-warning"><i class="fas fa-user-clock"></i> Under-utilized Employees</h6>
                            <div class="col">
                                {% for emp in empsNumDays %}
                                    {% if emp|length >= 4 %}
                                        {% comment %}Enhanced format with utilization data{% endcomment %}
                                        {% with days=emp.1 utilization=emp.2 status=emp.3 %}
                                            {% if status == 'under' %}
                                            <div class="col-md-6 mb-2">
                                                <div class="d-flex justify-content-between">
                                                    <span>{{emp.0.first_name}} {{emp.0.last_name}}</span>
                                                    <span class="badge bg-warning text-white">{{days}} days ({{utilization}}%)</span>
                                                </div>
                                            </div>
                                            {% endif %}
                                        {% endwith %}
                                    {% else %}
                                        {% comment %}Legacy format fallback{% endcomment %}
                                        {% with days=emp.1 %}
                                            {% if days < 20 %}
                                            <div class="col-md-6 mb-2">
                                                <div class="d-flex justify-content-between">
                                                    <span>{{emp.0.first_name}} {{emp.0.last_name}}</span>
                                                    <span class="badge bg-warning text-white">{{days}} days</span>
                                                </div>
                                            </div>
                                            {% endif %}
                                        {% endwith %}
                                    {% endif %}
                                {% empty %}
                                <p class="text-muted">No under-utilized employees</p>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="collapse mt-3" id="overutilizedEmployees" style="display: none;">
                        <div class="card card-body bg-light">
                            <h6 class="text-danger"><i class="fas fa-fire"></i> Over-utilized Employees</h6>
                            <div class="col">
                                {% for emp in empsNumDays %}
                                    {% if emp|length >= 4 %}
                                        {% comment %}Enhanced format with utilization data{% endcomment %}
                                        {% with days=emp.1 utilization=emp.2 status=emp.3 %}
                                            {% if status == 'over' %}
                                            <div class="col-md-6 mb-2">
                                                <div class="d-flex justify-content-between">
                                                    <span>{{emp.0.first_name}} {{emp.0.last_name}}</span>
                                                    <span class="badge bg-danger text-white">{{days}} days ({{utilization}}%)</span>
                                                </div>
                                            </div>
                                            {% endif %}
                                        {% endwith %}
                                    {% else %}
                                        {% comment %}Legacy format fallback{% endcomment %}
                                        {% with days=emp.1 %}
                                            {% if days > 60 %}
                                            <div class="col-md-6 mb-2">
                                                <div class="d-flex justify-content-between">
                                                    <span>{{emp.0.first_name}} {{emp.0.last_name}}</span>
                                                    <span class="badge bg-danger text-white">{{days}} days</span>
                                                </div>
                                            </div>
                                            {% endif %}
                                        {% endwith %}
                                    {% endif %}
                                {% empty %}
                                <p class="text-muted">No over-utilized employees</p>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    <p class="text-muted text-center">Average Team Utilization: <strong>{{team_utilization|default:0}}%</strong></p>
                </div>
            </div>
        </div>

        <!-- Action Required Alerts -->
        <div class="col-xl-6 col-lg-12 mb-4">
            <div class="card shadow">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-danger">Action Required</h6>
                    <i class="fas fa-exclamation-circle"></i>
                </div>
                <div class="card-body">
                    {% if underutilized_employees > 0 %}
                    <div class="alert alert-warning fade show" role="alert">
                        <strong><i class="fas fa-user-clock"></i> {{underutilized_employees}} Under-utilized Employee{{underutilized_employees|pluralize}}</strong><br>
                        Consider assigning additional work or training.
                    </div>
                    {% endif %}
                    
                    {% if critical_vulnerabilities > 0 %}
                    <div class="alert alert-danger fade show" role="alert">
                        <strong><i class="fas fa-shield-alt"></i> {{critical_vulnerabilities}} Critical Vulnerabilities</strong><br>
                        Immediate attention required for client security.
                    </div>
                    {% endif %}
                    
                    {% if inactive_clients > 0 %}
                    <div class="alert alert-info fade show" role="alert">
                        <strong><i class="fas fa-handshake"></i> {{inactive_clients}} Client{{inactive_clients|pluralize}} Need{{inactive_clients|pluralize:"s,"}} Attention</strong><br>
                        No recent engagement activity detected.
                    </div>
                    {% endif %}
                    
                    {% if not underutilized_employees and not critical_vulnerabilities and not inactive_clients %}
                    <div class="text-success">
                        <i class="fas fa-check-circle"></i> No critical issues requiring immediate attention.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>


    <!-- Completed Services Modal -->
    <div class="modal fade" id="completedServicesModal" tabindex="-1" role="dialog" aria-labelledby="completedServicesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="completedServicesModalLabel">
                        <i class="fas fa-check-circle mr-2"></i>
                        Completed Services Details
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle mr-2"></i>
                                Showing completed services from <strong id="modalDateRange"></strong>
                            </div>
                        </div>
                    </div>
                    
                    <!-- View Toggle Buttons -->
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="btn-group" role="group" aria-label="View Toggle">
                                <button type="button" class="btn btn-outline-primary active" id="groupedViewBtn" onclick="showGroupedView()">
                                    <i class="fas fa-layer-group mr-2"></i>Service Types
                                </button>
                                <button type="button" class="btn btn-outline-primary" id="detailedViewBtn" onclick="showDetailedView()">
                                    <i class="fas fa-list mr-2"></i>Individual Services
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Grouped Services View -->
                    <div id="groupedServicesView" class="table-responsive">
                        <table class="table table-hover">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Service Type</th>
                                    <th>Count</th>
                                    <th>Clients Served</th>
                                    <th>Avg Duration</th>
                                    <th>Avg Team Size</th>
                                    <th>Completion Rate</th>
                                    <th>Open Vulnerabilities</th>
                                    <th>Risk Level</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="groupedServicesTableBody">
                                <!-- Grouped content will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Detailed Services View -->
                    <div id="detailedServicesView" class="table-responsive" style="display: none;">
                        <table class="table table-hover" id="completedServicesTable">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Service Name</th>
                                    <th>Client</th>
                                    <th>Service Type</th>
                                    <th>Duration</th>
                                    <th>Team</th>
                                    <th>Project Manager</th>
                                    <th>Completion Status</th>
                                    <th>Vulnerabilities</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="completedServicesTableBody">
                                <!-- Individual services content will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="noServicesMessage" class="text-center py-4" style="display: none;">
                        <div class="text-muted">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <h5>No Completed Services</h5>
                            <p>No services were completed during the selected date range.</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="mr-auto">
                        <small class="text-muted">
                            <i class="fas fa-chart-bar mr-1"></i>
                            Total Services: <span id="modalTotalServices">0</span> | 
                            <i class="fas fa-layer-group mr-1"></i>
                            Service Types: <span id="modalServiceTypes">0</span> |
                            <i class="fas fa-users mr-1"></i>
                            Clients Served: <span id="modalClientsServed">0</span> |
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            Open Vulnerabilities: <span id="modalOpenVulns">0</span>
                        </small>
                    </div>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times mr-2"></i>Close
                    </button>
                    <button type="button" class="btn btn-primary" onclick="exportCompletedServices()">
                        <i class="fas fa-download mr-2"></i>Export CSV
                    </button>
                </div>
            </div>
        </div>
    </div>

    
</div>

<style>
/* Clean Metric Cards */
.metric-card {
    background: #fff;
    border: 1px solid #e3e6f0;
    border-radius: 8px;
    padding: 16px;
    transition: box-shadow 0.2s ease;
}

.metric-card:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.metric-card.clickable-card:hover {
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
}

.metric-icon {
    width: 48px;
    height: 48px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    background: #5a67d8;
    color: white;
    font-size: 20px;
    flex-shrink: 0;
}
.icon-wrapper {
    width: 48px;
    height: 48px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
    font-size: 20px;
    flex-shrink: 0;
}

.metric-icon.utilization {
    background: #38b2ac;
}

.metric-icon.services {
    background: #48bb78;
}

.metric-icon.vulnerabilities {
    background: #e53e3e;
}

.metric-icon.critical-findings {
    background: linear-gradient(135deg, #dc2626 0%, #f59e0b 100%);
    box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
}

.metric-icon.clients-served {
    background: linear-gradient(135deg, #0ea5e9 0%, #10b981 100%);
    box-shadow: 0 2px 8px rgba(14, 165, 233, 0.3);
}

.metric-content {
    flex: 1;
}

.metric-value {
    font-size: 24px;
    font-weight: 700;
    color: #2d3748;
    line-height: 1;
    margin-bottom: 4px;
}

.metric-label {
    font-size: 12px;
    color: #718096;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
}

.metric-trend {
    margin-top: 0.375rem;
}

.trend-indicator {
    padding: 0.2rem 0.4rem;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 500;
    line-height: 1.2;
}

.manager-metric-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    border-radius: 16px 16px 0 0;
}

.working-days-card::before {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.cost-card::before {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}

.utilization-card::before {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
}

.services-card::before {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
}

.vulnerability-card::before {
    background: linear-gradient(135deg, #dc2626 0%, #f59e0b 100%);
}

.revenue-card::before {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}

.health-card::before {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.availability-card::before {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.cost-per-emp-card::before {
    background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
}

.variance-card::before {
    background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
}

.manager-metric-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
}

.bg-gradient-working-days {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.bg-gradient-cost {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}

.bg-gradient-utilization {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
}

.bg-gradient-vulnerability {
    background: linear-gradient(135deg, #dc2626 0%, #f59e0b 100%);
}

.bg-gradient-services {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
}

.bg-gradient-utilization {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.bg-gradient-revenue {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
}

.bg-gradient-health {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.bg-gradient-availability {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.bg-gradient-cost-per-emp {
    background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
}

.bg-gradient-variance {
    background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
}

.currency {
    font-size: 1.2rem;
    font-weight: 600;
    margin-left: 0.5rem;
    opacity: 0.8;
}

.coming-soon {
    font-size: 1.5rem !important;
    color: #9ca3af;
    font-style: italic;
}

.trend-indicator.working {
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
}

.trend-indicator.cost {
    background: rgba(17, 153, 142, 0.1);
    color: #11998e;
}

.trend-indicator.utilization {
    background: rgba(79, 70, 229, 0.1);
    color: #4f46e5;
}

.trend-indicator.vulnerability {
    background: rgba(220, 38, 38, 0.1);
    color: #dc2626;
}

.trend-indicator.services {
    background: rgba(59, 130, 246, 0.1);
    color: #3b82f6;
}

.trend-indicator.utilization {
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
}

.trend-indicator.revenue {
    background: rgba(17, 153, 142, 0.1);
    color: #11998e;
}

.trend-indicator.health {
    background: rgba(240, 147, 251, 0.1);
    color: #f093fb;
}

.trend-indicator.availability {
    background: rgba(79, 172, 254, 0.1);
    color: #4facfe;
}

.trend-indicator.cost-per-emp {
    background: rgba(255, 236, 210, 0.3);
    color: #fcb69f;
}

.trend-indicator.variance {
    background: rgba(255, 154, 158, 0.1);
    color: #ff9a9e;
}

/* Enhanced Manager Chart Card */
.enhanced-manager-chart-card {
    background: linear-gradient(145deg, #ffffff 0%, #f8f9ff 100%);
    border-radius: 16px;
    box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    overflow: hidden;
    margin-bottom: 2rem;
}

.enhanced-manager-chart-card:hover {
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    transform: translateY(-2px);
}

.enhanced-manager-chart-card .chart-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 2rem;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    position: relative;
    overflow: hidden;
}

.chart-stats {
    display: flex;
    gap: 1.5rem;
    align-items: center;
}

.stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
}

.stat-label {
    font-size: 0.75rem;
    opacity: 0.8;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.stat-value {
    font-size: 1.25rem;
    font-weight: 700;
}

.chart-container {
    position: relative;
    overflow-x: auto;
    padding: 1rem;
}

.chart-wrapper {
    background: rgba(255, 255, 255, 0.8);
    border-radius: 12px;
    padding: 2rem;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
}

/* Custom scrollbar for chart container */
.chart-container::-webkit-scrollbar {
    height: 8px;
}

.chart-container::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.05);
    border-radius: 4px;
}

.chart-container::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 4px;
}

.chart-container::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
}

/* Responsive improvements for manager dashboard */
@media (max-width: 768px) {
    .chart-header {
        flex-direction: column;
        gap: 1rem;
        padding: 1.5rem;
    }
    
    .chart-stats {
        flex-direction: column;
        gap: 1rem;
        width: 100%;
    }
    
    .stat-item {
        flex-direction: row;
        justify-content: space-between;
        width: 100%;
        background: rgba(255, 255, 255, 0.1);
        padding: 0.75rem;
        border-radius: 8px;
    }
    
    .chart-wrapper {
        padding: 1rem;
        min-width: 600px;
    }
    
    .manager-metric-card {
        padding: 1.5rem;
    }
    
    .metric-card-content {
        flex-direction: column;
        align-items: center;
        text-align: center;
        gap: 1rem;
    }
}

@media (max-width: 576px) {
    .chart-wrapper {
        min-width: 500px;
        padding: 0.75rem;
    }
    
    .chart-title {
        font-size: 1.25rem;
    }
    
    .metric-value {
        font-size: 2rem;
    }
}

/* Action Required Panel Styles */
.action-required-panel {
    background: linear-gradient(145deg, #fff5f5 0%, #ffffff 100%);
    border-radius: 16px;
    box-shadow: 0 2px 15px rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.1);
    overflow: hidden;
    margin-bottom: 2rem;
}

.action-header {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    padding: 1.5rem 2rem;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
}

.action-title {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 700;
    display: flex;
    align-items: center;
}

.action-count {
    background: rgba(255, 255, 255, 0.2);
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.875rem;
    margin-left: 1rem;
    animation: count-pulse 2s ease-in-out infinite;
}

@keyframes count-pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.action-controls .btn {
    border-color: rgba(255, 255, 255, 0.3);
    color: white;
}

.action-controls .btn:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.5);
}

.action-body {
    padding: 2rem;
}

.action-item {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    border: 1px solid #f1f5f9;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.action-item::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    transition: width 0.3s ease;
}

.action-item.critical-action::before {
    background: linear-gradient(135deg, #ef4444, #dc2626);
}

.action-item.warning-action::before {
    background: linear-gradient(135deg, #f59e0b, #d97706);
}

.action-item.info-action::before {
    background: linear-gradient(135deg, #06b6d4, #0891b2);
}

.action-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.action-item:hover::before {
    width: 8px;
}

.action-item-icon .icon-circle {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.25rem;
}

.action-item-content {
    flex: 1;
}

.action-item-title {
    margin: 0 0 0.5rem 0;
    font-size: 1.1rem;
    font-weight: 600;
    color: #1f2937;
}

.action-item-desc {
    margin: 0 0 0.75rem 0;
    color: #6b7280;
    line-height: 1.5;
}

.action-item-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.priority-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.priority-badge.critical {
    background: #fef2f2;
    color: #dc2626;
}

.priority-badge.high {
    background: #fffbeb;
    color: #d97706;
}

.priority-badge.medium {
    background: #f0f9ff;
    color: #0891b2;
}

.time-stamp {
    font-size: 0.75rem;
    color: #9ca3af;
}

.action-item-controls {
    flex-shrink: 0;
}

/* Quick Actions Panel Styles */
.quick-actions-panel {
    background: linear-gradient(145deg, #f0fdf4 0%, #ffffff 100%);
    border-radius: 16px;
    box-shadow: 0 2px 15px rgba(34, 197, 94, 0.1);
    border: 1px solid rgba(34, 197, 94, 0.1);
    overflow: hidden;
    margin-bottom: 2rem;
}

.quick-actions-header {
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    padding: 1.5rem 2rem;
    color: white;
}

.quick-actions-title {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 700;
    display: flex;
    align-items: center;
}

.quick-actions-grid {
    padding: 2rem;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
}

.quick-action-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 1px solid #f1f5f9;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    position: relative;
    overflow: hidden;
}

.quick-action-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    transform: scaleX(0);
    transition: transform 0.3s ease;
}

.quick-action-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
}

.quick-action-card:hover::before {
    transform: scaleX(1);
}

.quick-action-icon {
    width: 60px;
    height: 60px;
    margin: 0 auto 1rem;
    background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    transition: all 0.3s ease;
}

.quick-action-card:hover .quick-action-icon {
    transform: scale(1.1) rotate(10deg);
}

.quick-action-label {
    font-size: 1rem;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 0.5rem;
}

.quick-action-desc {
    font-size: 0.875rem;
    color: #6b7280;
    line-height: 1.4;
}

/* Additional Animations */
.action-icon-bounce {
    animation: icon-bounce 2s ease-in-out infinite;
}

@keyframes icon-bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-3px); }
}

.utilization-pulse {
    animation: utilization-pulse 2s ease-in-out infinite;
}

@keyframes utilization-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.revenue-growth {
    animation: revenue-growth 3s ease-in-out infinite;
}

@keyframes revenue-growth {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    25% { transform: translateY(-2px) rotate(5deg); }
    75% { transform: translateY(2px) rotate(-5deg); }
}

.health-beat {
    animation: health-beat 1.5s ease-in-out infinite;
}

@keyframes health-beat {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.availability-blink {
    animation: availability-blink 2s ease-in-out infinite;
}

@keyframes availability-blink {
    0%, 50%, 100% { opacity: 1; }
    25%, 75% { opacity: 0.5; }
}

.cost-calculate {
    animation: cost-calculate 2s linear infinite;
}

@keyframes cost-calculate {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.variance-pulse {
    animation: variance-pulse 1s ease-in-out infinite;
}

@keyframes variance-pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
    .action-header,
    .quick-actions-header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .action-controls {
        display: flex;
        gap: 0.5rem;
    }
    
    .action-item {
        flex-direction: column;
        text-align: center;
        gap: 1rem;
    }
    
    .action-item-meta {
        justify-content: center;
    }
    
    .quick-actions-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
    }
}

/* ===== MANAGER DASHBOARD DELIGHTFUL ENHANCEMENTS ===== */

/* Calendar Animation */
.calendar-flip {
    animation: calendar-page-flip 3s ease-in-out infinite;
}

@keyframes calendar-page-flip {
    0%, 90%, 100% { transform: rotateY(0deg); }
    45% { transform: rotateY(180deg); }
}

.celebration-card:hover .calendar-flip {
    animation: calendar-celebration 0.8s ease-out;
}

@keyframes calendar-celebration {
    0%, 100% { 
        transform: rotateY(0deg) scale(1);
    }
    25% { 
        transform: rotateY(90deg) scale(1.1);
    }
    75% { 
        transform: rotateY(270deg) scale(1.1);
    }
}

/* Money Animations */
.money-bounce {
    animation: money-jump 2s ease-in-out infinite;
}

@keyframes money-jump {
    0%, 100% { transform: translateY(0) scale(1); }
    50% { transform: translateY(-5px) scale(1.1); }
}

.money-card:hover .money-bounce {
    animation: money-celebration 1s ease-out;
}

@keyframes money-celebration {
    0%, 100% { 
        transform: scale(1) rotate(0deg);
    }
    25% { 
        transform: scale(1.2) rotate(10deg);
    }
    75% { 
        transform: scale(1.2) rotate(-10deg);
    }
}

.sparkle-currency {
    position: relative;
    animation: currency-glow 2s ease-in-out infinite;
}

@keyframes currency-glow {
    0%, 100% { 
        text-shadow: 0 0 5px rgba(17, 153, 142, 0.3);
    }
    50% { 
        text-shadow: 0 0 15px rgba(17, 153, 142, 0.6),
                     0 0 25px rgba(17, 153, 142, 0.4);
    }
}

.money-celebrate:hover::after {
    content: 'ðŸ’°';
    position: absolute;
    top: -20px;
    right: -10px;
    font-size: 1.2rem;
    animation: money-float 1s ease-out;
}

@keyframes money-float {
    0% {
        transform: translateY(0) rotate(0deg);
        opacity: 1;
    }
    100% {
        transform: translateY(-30px) rotate(360deg);
        opacity: 0;
    }
}

/* Exciting Coming Soon */
.exciting-soon {
    position: relative;
    background: linear-gradient(45deg, #a8a8a8, #d4d4d4, #f0f0f0, #d4d4d4, #a8a8a8);
    background-size: 400% 400%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: exciting-gradient 3s ease-in-out infinite, gentle-bounce 2s ease-in-out infinite;
}

@keyframes exciting-gradient {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}

.exciting-soon::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 110%;
    transform: translateY(-50%);
    width: 0;
    height: 0;
    border-left: 8px solid #d4d4d4;
    border-top: 8px solid transparent;
    border-bottom: 8px solid transparent;
    animation: arrow-pulse 1.5s ease-in-out infinite;
}

@keyframes arrow-pulse {
    0%, 100% { opacity: 0.5; transform: translateY(-50%) translateX(0); }
    50% { opacity: 1; transform: translateY(-50%) translateX(5px); }
}

/* Analytics Sparkle */
.analytics-sparkle {
    position: absolute;
    top: -8px;
    right: 15px;
    font-size: 1.1em;
    animation: analytics-twinkle 2.5s infinite;
}

@keyframes analytics-twinkle {
    0%, 100% { 
        opacity: 0.6;
        transform: scale(1) rotate(0deg);
    }
    33% { 
        opacity: 1;
        transform: scale(1.3) rotate(120deg);
    }
    66% { 
        opacity: 0.8;
        transform: scale(0.9) rotate(240deg);
    }
}

/* Enhanced Chart Hover Effects */
.enhanced-manager-chart-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
}

.chart-wrapper {
    position: relative;
}

.chart-wrapper::before {
    content: '';
    position: absolute;
    top: -5px;
    left: -5px;
    right: -5px;
    bottom: -5px;
    background: linear-gradient(45deg, transparent, rgba(102, 126, 234, 0.1), transparent);
    border-radius: 16px;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
}

.enhanced-manager-chart-card:hover .chart-wrapper::before {
    opacity: 1;
    animation: chart-glow 2s ease-in-out infinite;
}

@keyframes chart-glow {
    0%, 100% { 
        background: linear-gradient(45deg, transparent, rgba(102, 126, 234, 0.1), transparent);
    }
    50% { 
        background: linear-gradient(45deg, transparent, rgba(102, 126, 234, 0.2), transparent);
    }
}

/* Celebration Numbers */
.celebration-number[data-days]:hover::before {
    content: 'ðŸŽ†';
    position: absolute;
    top: -15px;
    left: -15px;
    font-size: 1.5rem;
    animation: celebration-burst 1s ease-out;
}

@keyframes celebration-burst {
    0% {
        transform: scale(0) rotate(0deg);
        opacity: 1;
    }
    50% {
        transform: scale(1.2) rotate(180deg);
        opacity: 1;
    }
    100% {
        transform: scale(0.8) rotate(360deg);
        opacity: 0;
    }
}

/* Trend Text Enhancements */
.trend-text {
    display: inline-block;
    animation: slide-in-right 0.6s ease-out;
}

@keyframes slide-in-right {
    0% {
        opacity: 0;
        transform: translateX(-15px);
    }
    100% {
        opacity: 1;
        transform: translateX(0);
    }
}

/* Counter Animation Enhancement */
.counter-animate {
    animation: count-up-manager 1s ease-out;
}

@keyframes count-up-manager {
    0% {
        transform: scale(0.5) rotateY(-90deg);
        opacity: 0;
    }
    50% {
        transform: scale(1.2) rotateY(0deg);
    }
    100% {
        transform: scale(1) rotateY(0deg);
        opacity: 1;
    }
}

/* Stats Section Enhancements */
.stat-item {
    transition: all 0.3s ease;
    position: relative;
}

.stat-item:hover {
    transform: translateY(-2px);
    background: rgba(255, 255, 255, 0.2) !important;
}

.stat-item:hover .stat-value::after {
    content: 'âœ¨';
    position: absolute;
    top: -10px;
    right: -15px;
    font-size: 0.9rem;
    animation: stat-twinkle 1s ease-out;
}

@keyframes stat-twinkle {
    0%, 100% { 
        opacity: 0;
        transform: scale(0.5) rotate(0deg);
    }
    50% { 
        opacity: 1;
        transform: scale(1) rotate(180deg);
    }
}

/* Additional optimizations for metric cards */
.metric-card-content {
    display: flex;
    flex-direction: column;
    height: 100%;
    justify-content: space-between;
}

.metric-info {
    min-width: 0;
    flex: 1;
}

.metric-icon {
    display: flex;
    align-items: center;
}

/* Ensure consistent spacing */
.manager-metrics-row .col-xl-3 {
    margin-bottom: 1rem;
}

/* Mobile Responsiveness for Delightful Elements */
@media (max-width: 768px) {
    .analytics-sparkle,
    .celebration-number[data-days]:hover::before,
    .money-celebrate:hover::after {
        display: none;
    }
    
    .exciting-soon::after {
        display: none;
    }
    
    .calendar-flip,
    .money-bounce {
        animation: none;
    }
    
    .manager-metric-card {
        padding: 0.875rem;
        min-height: 100px;
    }
    
    .metric-value {
        font-size: 1.4rem;
    }
    
    .metric-label {
        font-size: 0.75rem;
    }
}

/* Accessibility: Reduced motion */
@media (prefers-reduced-motion: reduce) {
    .calendar-flip,
    .money-bounce,
    .exciting-soon,
    .analytics-twinkle,
    .counter-animate,
    .chart-glow,
    .celebration-burst,
    .slide-in-right,
    .count-up-manager,
    .stat-twinkle {
        animation: none !important;
    }
    
    .enhanced-manager-chart-card:hover,
    .stat-item:hover {
        transform: none !important;
    }
}

/* Mobile responsiveness for metric cards */
@media (max-width: 768px) {
    .metric-card {
        padding: 12px;
    }
    
    .metric-icon {
        width: 40px;
        height: 40px;
        font-size: 18px;
        margin-right: 10px;
    }
    
    .icon-wrapper {
        width: 40px;
        height: 40px;
        font-size: 18px;
        margin-right: 10px;
    }
    
    .metric-value {
        font-size: 20px;
    }
    
    .metric-label {
        font-size: 11px;
    }
}

/* Professional Update Button Styles */
.update-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    border-radius: 8px;
    color: white;
    padding: 8px 20px;
    font-size: 14px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    position: relative;
    overflow: hidden;
    min-width: 100px;
    justify-content: center;
}

.update-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.6s;
}

.update-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
}

.update-btn:hover::before {
    left: 100%;
}

.update-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.update-btn.loading {
    pointer-events: none;
    background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
}

.update-btn.loading .btn-icon {
    animation: spin 1s linear infinite;
}

.update-btn .btn-icon {
    font-size: 12px;
    transition: transform 0.3s ease;
}

.update-btn:hover .btn-icon {
    transform: rotate(180deg);
}

.btn-text {
    font-size: 13px;
    letter-spacing: 0.3px;
}

/* Date Error Message Styles */
.date-error-message {
    background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
    border: 1px solid #fca5a5;
    border-radius: 8px;
    color: #dc2626;
    padding: 12px 16px;
    margin-top: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    font-weight: 500;
    animation: shake 0.5s ease-in-out;
    position: relative;
}

.date-error-message::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: #dc2626;
    border-radius: 4px 0 0 4px;
}

.date-error-message i {
    color: #dc2626;
    font-size: 16px;
    animation: pulse 2s infinite;
}

/* Animations */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

/* Responsive Design */
@media (max-width: 768px) {
    .update-btn {
        padding: 6px 16px;
        font-size: 13px;
        min-width: 90px;
    }
    
    .update-btn .btn-icon {
        font-size: 11px;
    }
    
    .btn-text {
        font-size: 12px;
    }
    
    .date-error-message {
        font-size: 13px;
        padding: 10px 14px;
    }
}

</style>
                    <script>
                        // Date Validation Function
                        function validateDateRange(event) {
                            const form = event.target;
                            const startDateInput = form.querySelector('input[name="start_date"]');
                            const endDateInput = form.querySelector('input[name="end_date"]');
                            const errorMessage = document.getElementById('dateError');
                            
                            if (startDateInput && endDateInput && startDateInput.value && endDateInput.value) {
                                const startDate = new Date(startDateInput.value);
                                const endDate = new Date(endDateInput.value);
                                
                                if (startDate > endDate) {
                                    // Show error message
                                    if (errorMessage) {
                                        errorMessage.style.display = 'flex';
                                        errorMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                                    }
                                    
                                    // Add visual feedback
                                    startDateInput.style.border = '2px solid #dc2626';
                                    endDateInput.style.border = '2px solid #dc2626';
                                    
                                    // Add shake animation to button
                                    const updateButton = document.getElementById('updateButton');
                                    if (updateButton) {
                                        updateButton.style.animation = 'shake 0.5s ease-in-out';
                                        setTimeout(() => {
                                            updateButton.style.animation = '';
                                        }, 500);
                                    }
                                    
                                    // Reset border colors after 3 seconds
                                    setTimeout(() => {
                                        startDateInput.style.border = '';
                                        endDateInput.style.border = '';
                                    }, 3000);
                                    
                                    return false; // Prevent form submission
                                }
                            }
                            
                            return true; // Allow form submission
                        }
                        
                        // Enhanced Chart Configuration
                        const names = [];
                        {% for emp in empsNumDays%}
                            names.push('{{ emp.0 }}');
                        {% endfor %}

                        const days = [];
                        {% for eng in empsNumDays%}
                            days.push({{ eng.1 }});
                        {% endfor %}

                        // Modern gradient colors
                        const gradientColors = [
                            { bg: 'rgba(102, 126, 234, 0.8)', border: 'rgba(102, 126, 234, 1)' },
                            { bg: 'rgba(17, 153, 142, 0.8)', border: 'rgba(17, 153, 142, 1)' },
                            { bg: 'rgba(250, 112, 154, 0.8)', border: 'rgba(250, 112, 154, 1)' },
                            { bg: 'rgba(79, 172, 254, 0.8)', border: 'rgba(79, 172, 254, 1)' },
                            { bg: 'rgba(245, 101, 101, 0.8)', border: 'rgba(245, 101, 101, 1)' },
                            { bg: 'rgba(139, 92, 246, 0.8)', border: 'rgba(139, 92, 246, 1)' },
                            { bg: 'rgba(251, 191, 36, 0.8)', border: 'rgba(251, 191, 36, 1)' },
                            { bg: 'rgba(52, 211, 153, 0.8)', border: 'rgba(52, 211, 153, 1)' }
                        ];

                        const backgroundColors = [];
                        const borderColors = [];
                        
                        for (let i = 0; i < names.length; i++) {
                            const colorIndex = i % gradientColors.length;
                            backgroundColors.push(gradientColors[colorIndex].bg);
                            borderColors.push(gradientColors[colorIndex].border);
                        }

                        const ctx = document.getElementById('myChart').getContext('2d');
                        
                        // Create gradient backgrounds
                        const chartGradients = backgroundColors.map((color, index) => {
                            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                            gradient.addColorStop(0, borderColors[index]);
                            gradient.addColorStop(1, color);
                            return gradient;
                        });
                        
                        const myChart = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: names,
                                datasets: [{
                                    label: 'Working Days',
                                    data: days,
                                    backgroundColor: chartGradients,
                                    borderColor: borderColors,
                                    borderWidth: 2,
                                    borderRadius: 8,
                                    borderSkipped: false,
                                    hoverBackgroundColor: borderColors,
                                    hoverBorderColor: borderColors,
                                    hoverBorderWidth: 3
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    tooltip: {
                                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                        titleColor: '#fff',
                                        bodyColor: '#fff',
                                        borderColor: 'rgba(102, 126, 234, 1)',
                                        borderWidth: 1,
                                        cornerRadius: 8,
                                        padding: 12,
                                        titleFont: {
                                            size: 14,
                                            weight: 'bold'
                                        },
                                        bodyFont: {
                                            size: 13
                                        },
                                        callbacks: {
                                            title: function(context) {
                                                return context[0].label;
                                            },
                                            label: function(context) {
                                                return `Working Days: ${context.parsed.y}`;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    x: {
                                        display: true,
                                        grid: {
                                            display: false
                                        },
                                        ticks: {
                                            color: '#6b7280',
                                            font: {
                                                size: 12,
                                                weight: '500'
                                            },
                                            maxRotation: 45,
                                            minRotation: 0
                                        }
                                    },
                                    y: {
                                        display: true,
                                        beginAtZero: true,
                                        grid: {
                                            color: 'rgba(107, 114, 128, 0.1)',
                                            drawBorder: false
                                        },
                                        ticks: {
                                            color: '#6b7280',
                                            font: {
                                                size: 12,
                                                weight: '500'
                                            },
                                            padding: 10
                                        }
                                    }
                                },
                                interaction: {
                                    intersect: false,
                                    mode: 'index'
                                },
                                animation: {
                                    duration: 1000,
                                    easing: 'easeOutQuart'
                                },
                                hover: {
                                    animationDuration: 200
                                }
                            }
                        });
                        
                        // Add hover effects
                        ctx.canvas.addEventListener('mousemove', function(e) {
                            const rect = ctx.canvas.getBoundingClientRect();
                            const x = e.clientX - rect.left;
                            const y = e.clientY - rect.top;
                            
                            const points = myChart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
                            
                            if (points.length) {
                                ctx.canvas.style.cursor = 'pointer';
                            } else {
                                ctx.canvas.style.cursor = 'default';
                            }
                        });
                        
                        // ===== MANAGER DASHBOARD DELIGHTFUL ENHANCEMENTS =====
                        
                        // Chart interaction enhancements
                        const chartContainer = document.querySelector('.chart-wrapper');
                        let isChartHovered = false;
                        
                        // Add hover effects for chart
                        if (chartContainer) {
                            chartContainer.addEventListener('mouseenter', function() {
                                isChartHovered = true;
                                this.style.transform = 'scale(1.02)';
                                this.style.transition = 'transform 0.3s ease';
                            });
                            
                            chartContainer.addEventListener('mouseleave', function() {
                                isChartHovered = false;
                                this.style.transform = 'scale(1)';
                            });
                        }
                        
                        // Add celebration for high performance metrics
                        function celebrateMetrics() {
                            const workingDaysValue = parseInt('{{allEmpDays}}');
                            const costValue = parseFloat('{{allEmpDaysCost}}'.replace(/[^0-9.-]+/g, ''));
                            
                            // Celebrate if metrics are high
                            if (workingDaysValue > 100) {
                                setTimeout(() => {
                                    createFloatingEmoji('ðŸŽ†', '.celebration-card[data-metric="working-days"]');
                                }, 1000);
                            }
                            
                            if (costValue > 50000) {
                                setTimeout(() => {
                                    createFloatingEmoji('ðŸ’°', '.money-card[data-metric="cost"]');
                                }, 1500);
                            }
                        }
                        
                        // Create floating emoji animation
                        function createFloatingEmoji(emoji, targetSelector) {
                            const target = document.querySelector(targetSelector);
                            if (!target) return;
                            
                            const rect = target.getBoundingClientRect();
                            const floater = document.createElement('div');
                            floater.textContent = emoji;
                            floater.style.cssText = `
                                position: fixed;
                                left: ${rect.left + rect.width/2}px;
                                top: ${rect.top + rect.height/2}px;
                                font-size: 2rem;
                                pointer-events: none;
                                z-index: 1000;
                                animation: float-celebration 3s ease-out forwards;
                            `;
                            
                            document.body.appendChild(floater);
                            setTimeout(() => floater.remove(), 3000);
                        }
                        
                        // Add floating animation keyframes
                        const floatingStyles = `
                            @keyframes float-celebration {
                                0% {
                                    transform: translate(-50%, -50%) scale(0) rotate(0deg);
                                    opacity: 1;
                                }
                                50% {
                                    transform: translate(-50%, -150%) scale(1.5) rotate(180deg);
                                    opacity: 1;
                                }
                                100% {
                                    transform: translate(-50%, -200%) scale(0.5) rotate(360deg);
                                    opacity: 0;
                                }
                            }
                            
                            .metric-celebration {
                                animation: metric-glow 2s ease-in-out;
                            }
                            
                            @keyframes metric-glow {
                                0%, 100% {
                                    box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
                                }
                                50% {
                                    box-shadow: 0 8px 30px rgba(102, 126, 234, 0.3),
                                                0 0 50px rgba(102, 126, 234, 0.1);
                                }
                            }
                        `;
                        
                        // Add styles to head
                        const styleSheet = document.createElement('style');
                        styleSheet.textContent = floatingStyles;
                        document.head.appendChild(styleSheet);
                        
                        // Trigger celebrations on page load
                        setTimeout(celebrateMetrics, 2000);
                        
                        // Add interactive tooltips for future cards
                        const futureCards = document.querySelectorAll('.future-card');
                        futureCards.forEach(card => {
                            card.addEventListener('mouseenter', function() {
                                const tooltip = document.createElement('div');
                                tooltip.className = 'future-tooltip';
                                tooltip.innerHTML = `
                                    <div class="tooltip-content">
                                        <span class="tooltip-emoji">ðŸš€</span>
                                        <span class="tooltip-text">Exciting features coming your way!</span>
                                    </div>
                                `;
                                tooltip.style.cssText = `
                                    position: absolute;
                                    top: -60px;
                                    left: 50%;
                                    transform: translateX(-50%);
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    color: white;
                                    padding: 0.75rem 1rem;
                                    border-radius: 12px;
                                    font-size: 0.9rem;
                                    white-space: nowrap;
                                    z-index: 1000;
                                    animation: tooltip-appear 0.3s ease-out;
                                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                                `;
                                
                                const tooltipStyles = `
                                    @keyframes tooltip-appear {
                                        0% {
                                            opacity: 0;
                                            transform: translateX(-50%) translateY(10px) scale(0.8);
                                        }
                                        100% {
                                            opacity: 1;
                                            transform: translateX(-50%) translateY(0) scale(1);
                                        }
                                    }
                                    .tooltip-content {
                                        display: flex;
                                        align-items: center;
                                        gap: 0.5rem;
                                    }
                                    .tooltip-emoji {
                                        animation: tooltip-bounce 1s ease-in-out infinite;
                                    }
                                    @keyframes tooltip-bounce {
                                        0%, 100% { transform: translateY(0); }
                                        50% { transform: translateY(-3px); }
                                    }
                                `;
                                
                                if (!document.querySelector('#tooltip-styles')) {
                                    const tooltipStyleSheet = document.createElement('style');
                                    tooltipStyleSheet.id = 'tooltip-styles';
                                    tooltipStyleSheet.textContent = tooltipStyles;
                                    document.head.appendChild(tooltipStyleSheet);
                                }
                                
                                this.style.position = 'relative';
                                this.appendChild(tooltip);
                            });
                            
                            card.addEventListener('mouseleave', function() {
                                const tooltip = this.querySelector('.future-tooltip');
                                if (tooltip) {
                                    tooltip.style.animation = 'tooltip-disappear 0.2s ease-in forwards';
                                    setTimeout(() => tooltip.remove(), 200);
                                }
                            });
                        });
                        
                        // Add tooltip disappear animation
                        const disappearAnimation = `
                            @keyframes tooltip-disappear {
                                0% {
                                    opacity: 1;
                                    transform: translateX(-50%) translateY(0) scale(1);
                                }
                                100% {
                                    opacity: 0;
                                    transform: translateX(-50%) translateY(-10px) scale(0.8);
                                }
                            }
                        `;
                        
                        const disappearStyleSheet = document.createElement('style');
                        disappearStyleSheet.textContent = disappearAnimation;
                        document.head.appendChild(disappearStyleSheet);
                        
                        // Add chart data celebration
                        myChart.options.onHover = function(event, elements) {
                            if (elements.length > 0) {
                                const element = elements[0];
                                const dataIndex = element.index;
                                const value = days[dataIndex];
                                
                                // Celebrate high performers
                                if (value > 20) {
                                    this.canvas.style.cursor = 'pointer';
                                    
                                    // Add subtle glow effect
                                    const chartRect = this.canvas.getBoundingClientRect();
                                    const glowElement = document.createElement('div');
                                    glowElement.style.cssText = `
                                        position: fixed;
                                        left: ${chartRect.left}px;
                                        top: ${chartRect.top}px;
                                        width: ${chartRect.width}px;
                                        height: ${chartRect.height}px;
                                        background: radial-gradient(circle, rgba(102, 126, 234, 0.1) 0%, transparent 70%);
                                        pointer-events: none;
                                        border-radius: 12px;
                                        z-index: -1;
                                        animation: chart-highlight 1s ease-out;
                                    `;
                                    
                                    document.body.appendChild(glowElement);
                                    setTimeout(() => glowElement.remove(), 1000);
                                }
                            } else {
                                this.canvas.style.cursor = 'default';
                            }
                        };
                        
                        // Add chart highlight animation
                        const chartHighlightStyles = `
                            @keyframes chart-highlight {
                                0% {
                                    opacity: 0;
                                    transform: scale(0.95);
                                }
                                50% {
                                    opacity: 1;
                                    transform: scale(1.02);
                                }
                                100% {
                                    opacity: 0;
                                    transform: scale(1);
                                }
                            }
                        `;
                        
                        const chartStyleSheet = document.createElement('style');
                        chartStyleSheet.textContent = chartHighlightStyles;
                        document.head.appendChild(chartStyleSheet);
                        
                        // Enhanced Quick Action Functions
                        window.assignEmployee = function() {
                            showActionModal('Assign Employee', 'Select an employee and assign them to a project or task.', 'fas fa-user-plus', () => {
                                console.log('Employee assignment initiated');
                            });
                        };
                        
                        window.requestReport = function() {
                            showActionModal('Request Report', 'Generate a comprehensive performance or financial report.', 'fas fa-file-alt', () => {
                                console.log('Report generation initiated');
                            });
                        };
                        
                        window.scheduleReview = function() {
                            showActionModal('Schedule Review', 'Plan a team performance review or client meeting.', 'fas fa-calendar-check', () => {
                                console.log('Review scheduling initiated');
                            });
                        };
                        
                        window.exportData = function() {
                            const btn = event.target.closest('.quick-action-card');
                            if (btn) {
                                btn.style.pointerEvents = 'none';
                                const icon = btn.querySelector('.quick-action-icon i');
                                const label = btn.querySelector('.quick-action-label');
                                
                                icon.className = 'fas fa-spinner fa-spin';
                                label.textContent = 'Exporting...';
                                
                                setTimeout(() => {
                                    icon.className = 'fas fa-check';
                                    label.textContent = 'Complete!';
                                    btn.style.background = 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';
                                    btn.style.color = 'white';
                                    
                                    setTimeout(() => {
                                        icon.className = 'fas fa-download';
                                        label.textContent = 'Export Data';
                                        btn.style.background = '';
                                        btn.style.color = '';
                                        btn.style.pointerEvents = '';
                                    }, 2000);
                                }, 2000);
                            }
                        };
                        
                        window.manageTeam = function() {
                            showActionModal('Manage Team', 'Update team member roles, permissions, and settings.', 'fas fa-users-cog', () => {
                                console.log('Team management initiated');
                            });
                        };
                        
                        window.viewAnalytics = function() {
                            showActionModal('View Analytics', 'Explore detailed performance metrics and business intelligence.', 'fas fa-chart-bar', () => {
                                console.log('Analytics view initiated');
                            });
                        };
                        
                        // Action Required Functions
                        window.reviewEmployees = function() {
                            showActionModal('Review Employees', 'Review under-utilized employees and create action plans.', 'fas fa-user-clock', () => {
                                console.log('Employee review initiated');
                            });
                        };
                        
                        window.planCapacity = function() {
                            showActionModal('Plan Capacity', 'Analyze capacity needs and plan resource allocation.', 'fas fa-chart-line', () => {
                                console.log('Capacity planning initiated');
                            });
                        };
                        
                        window.contactClients = function() {
                            showActionModal('Contact Clients', 'Reach out to clients who need attention.', 'fas fa-phone', () => {
                                console.log('Client contact initiated');
                            });
                        };
                        
                        window.reviewVulnerabilities = function() {
                            showActionModal('Review Vulnerabilities', 'Examine and prioritize critical security vulnerabilities.', 'fas fa-shield-alt', () => {
                                console.log('Vulnerability review initiated');
                            });
                        };
                        
                        // Action Panel Functions
                        window.toggleActionPanel = function() {
                            const panel = document.getElementById('actionPanel');
                            const btn = event.target;
                            
                            if (panel.style.maxHeight && panel.style.maxHeight !== '0px') {
                                panel.style.maxHeight = '0px';
                                panel.style.overflow = 'hidden';
                                btn.innerHTML = '<i class="fas fa-eye"></i> View All';
                            } else {
                                panel.style.maxHeight = panel.scrollHeight + 'px';
                                panel.style.overflow = 'visible';
                                btn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide';
                            }
                        };
                        
                        window.dismissAll = function() {
                            if (confirm('Are you sure you want to mark all action items as done?')) {
                                const actionItems = document.querySelectorAll('.action-item');
                                actionItems.forEach((item, index) => {
                                    setTimeout(() => {
                                        item.style.opacity = '0.5';
                                        item.style.transform = 'translateX(100px)';
                                        
                                        setTimeout(() => {
                                            item.style.display = 'none';
                                        }, 300);
                                    }, index * 100);
                                });
                                
                                setTimeout(() => {
                                    const actionCount = document.querySelector('.action-count');
                                    actionCount.textContent = '0';
                                    document.getElementById('actionPanel').innerHTML = '<div class="text-center py-4"><i class="fas fa-check-circle text-success fa-3x mb-3"></i><h5>All caught up!</h5><p class="text-muted">No action items require your attention.</p></div>';
                                }, 1000);
                            }
                        };
                        
                        // Modal Helper Function
                        function showActionModal(title, message, icon, callback) {
                            const modal = document.createElement('div');
                            modal.innerHTML = `
                                <div class="action-modal-overlay" onclick="this.parentElement.remove()">
                                    <div class="action-modal" onclick="event.stopPropagation()">
                                        <div class="action-modal-header">
                                            <div class="action-modal-icon">
                                                <i class="${icon}"></i>
                                            </div>
                                            <h3>${title}</h3>
                                        </div>
                                        <div class="action-modal-body">
                                            <p>${message}</p>
                                        </div>
                                        <div class="action-modal-footer">
                                            <button class="btn btn-outline-secondary" onclick="this.closest('.action-modal-overlay').remove()">Cancel</button>
                                            <button class="btn btn-primary" onclick="${callback.toString().replace('function() {', '').replace(/}$/, '')}; this.closest('.action-modal-overlay').remove();">Proceed</button>
                                        </div>
                                    </div>
                                </div>
                            `;
                            
                            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 10000;';
                            
                            const modalStyles = `
                                .action-modal-overlay {
                                    background: rgba(0, 0, 0, 0.5);
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    width: 100%;
                                    height: 100%;
                                    animation: modal-fade-in 0.3s ease;
                                }
                                .action-modal {
                                    background: white;
                                    border-radius: 16px;
                                    max-width: 500px;
                                    width: 90%;
                                    max-height: 80vh;
                                    overflow-y: auto;
                                    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
                                    animation: modal-slide-up 0.3s ease;
                                }
                                .action-modal-header {
                                    padding: 2rem 2rem 1rem;
                                    text-align: center;
                                    border-bottom: 1px solid #f1f5f9;
                                }
                                .action-modal-icon {
                                    width: 80px;
                                    height: 80px;
                                    margin: 0 auto 1rem;
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    color: white;
                                    font-size: 2rem;
                                }
                                .action-modal-header h3 {
                                    margin: 0;
                                    color: #1f2937;
                                    font-weight: 600;
                                }
                                .action-modal-body {
                                    padding: 1.5rem 2rem;
                                }
                                .action-modal-body p {
                                    margin: 0;
                                    color: #6b7280;
                                    line-height: 1.6;
                                }
                                .action-modal-footer {
                                    padding: 1rem 2rem 2rem;
                                    display: flex;
                                    gap: 1rem;
                                    justify-content: flex-end;
                                }
                                @keyframes modal-fade-in {
                                    0% { opacity: 0; }
                                    100% { opacity: 1; }
                                }
                                @keyframes modal-slide-up {
                                    0% { transform: translateY(50px); opacity: 0; }
                                    100% { transform: translateY(0); opacity: 1; }
                                }
                            `;
                            
                            if (!document.querySelector('#modal-styles')) {
                                const modalStyleSheet = document.createElement('style');
                                modalStyleSheet.id = 'modal-styles';
                                modalStyleSheet.textContent = modalStyles;
                                document.head.appendChild(modalStyleSheet);
                            }
                            
                            document.body.appendChild(modal);
                        }
                        
                        // Enhanced metric celebrations
                        function celebrateMetrics() {
                            const metrics = [
                                { selector: '[data-metric="working-days"]', threshold: 100, emoji: 'ðŸŽ†' },
                                { selector: '[data-metric="cost"]', threshold: 50000, emoji: 'ðŸ’°' },
                                { selector: '[data-metric="utilization"]', threshold: 80, emoji: 'âš™ï¸' },
                                { selector: '[data-metric="revenue"]', threshold: 100000, emoji: 'ðŸ“ˆ' },
                                { selector: '[data-metric="health"]', threshold: 8, emoji: 'â¤ï¸' }
                            ];
                            
                            metrics.forEach((metric, index) => {
                                setTimeout(() => {
                                    const element = document.querySelector(metric.selector);
                                    if (element) {
                                        createFloatingEmoji(metric.emoji, metric.selector);
                                        element.classList.add('metric-celebration');
                                        setTimeout(() => element.classList.remove('metric-celebration'), 2000);
                                    }
                                }, 1000 + (index * 500));
                            });
                        }
                        
                        // Auto-update timestamps
                        function updateTimestamps() {
                            const timestamps = document.querySelectorAll('.time-stamp');
                            const now = new Date();
                            
                            timestamps.forEach(stamp => {
                                const randomMinutes = Math.floor(Math.random() * 60) + 1;
                                stamp.textContent = `Updated ${randomMinutes} minute${randomMinutes > 1 ? 's' : ''} ago`;
                            });
                        }
                        
                        // Initialize auto-updates
                        setInterval(updateTimestamps, 60000); // Update every minute
                        
                        
                        // Trigger enhanced celebrations
                        setTimeout(celebrateMetrics, 2500);
                        
                        // Employee Details Toggle Function
                        function toggleEmployeeDetails(targetId, button) {
                            const target = document.getElementById(targetId);
                            if (target) {
                                if (target.style.display === 'none' || target.style.display === '') {
                                    target.style.display = 'block';
                                    button.innerHTML = '<i class="fas fa-minus"></i> Hide Details';
                                } else {
                                    target.style.display = 'none';
                                    button.innerHTML = '<i class="fas fa-plus"></i> Show Details';
                                }
                            }
                        }

                        // Completed Services Modal Functions (will be overridden)
                        function showCompletedServicesModal() {
                            alert('Loading services data...');
                        }
                        
                        function populateServicesTable(services) {
                            const tableBody = document.getElementById('completedServicesTableBody');
                            const noServicesMessage = document.getElementById('noServicesMessage');
                            const servicesTable = document.getElementById('completedServicesTable');
                            
                            if (!services || services.length === 0) {
                                servicesTable.style.display = 'none';
                                noServicesMessage.style.display = 'block';
                                return;
                            }
                            
                            servicesTable.style.display = 'table';
                            noServicesMessage.style.display = 'none';
                            
                            // Clear existing content
                            tableBody.innerHTML = '';
                            
                            services.forEach(service => {
                                const row = createServiceRow(service);
                                tableBody.appendChild(row);
                            });
                        }
                        
                        function createServiceRow(service) {
                            const row = document.createElement('tr');
                            
                            // Determine status badge class and text
                            const statusInfo = getStatusInfo(service.completion_status);
                            const vulnerabilityInfo = getVulnerabilityInfo(service.vulnerabilities);
                            
                            row.innerHTML = `
                                <td>
                                    <strong>${escapeHtml(service.name)}</strong>
                                    <br><small class="text-muted">ID: ${service.id}</small>
                                </td>
                                <td>${escapeHtml(service.client_name)}</td>
                                <td>
                                    <span class="badge badge-info">${escapeHtml(service.service_type)}</span>
                                </td>
                                <td>
                                    ${service.duration_days} days
                                    <br><small class="text-muted">${formatDate(service.start_date)} - ${formatDate(service.end_date)}</small>
                                </td>
                                <td>
                                    <div class="team-info">
                                        <strong>${service.team_count}</strong> member${service.team_count !== 1 ? 's' : ''}
                                        <br><small class="text-muted">${service.team_members.join(', ')}</small>
                                    </div>
                                </td>
                                <td>${escapeHtml(service.project_manager)}</td>
                                <td>
                                    <span class="badge ${statusInfo.class}">${statusInfo.text}</span>
                                    <br><small class="text-muted">${Math.round(service.remediation_rate)}% remediated</small>
                                </td>
                                <td>
                                    ${vulnerabilityInfo.html}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-primary" onclick="viewEngagementDetails(${service.id})" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="viewTeamDetails('${service.team_members_full.join(', ')}')" title="View Team">
                                            <i class="fas fa-users"></i>
                                        </button>
                                    </div>
                                </td>
                            `;
                            
                            return row;
                        }
                        
                        function getStatusInfo(status) {
                            const statusMap = {
                                'complete': { class: 'badge-success', text: 'Complete' },
                                'critical_issues': { class: 'badge-danger', text: 'Critical Issues' },
                                'high_issues': { class: 'badge-warning', text: 'High Issues' },
                                'minor_issues': { class: 'badge-info', text: 'Minor Issues' }
                            };
                            return statusMap[status] || { class: 'badge-secondary', text: 'Unknown' };
                        }
                        
                        function getVulnerabilityInfo(vulns) {
                            if (vulns.total_open === 0 && vulns.total_fixed === 0) {
                                return {
                                    html: '<span class="text-muted"><i class="fas fa-check-circle text-success"></i> No vulnerabilities</span>'
                                };
                            }
                            
                            let html = '';
                            if (vulns.critical_open > 0) {
                                html += `<span class="badge badge-danger">${vulns.critical_open} Critical</span> `;
                            }
                            if (vulns.high_open > 0) {
                                html += `<span class="badge badge-warning">${vulns.high_open} High</span> `;
                            }
                            if (vulns.medium_open > 0) {
                                html += `<span class="badge badge-info">${vulns.medium_open} Medium</span> `;
                            }
                            if (vulns.low_open > 0) {
                                html += `<span class="badge badge-light">${vulns.low_open} Low</span> `;
                            }
                            if (vulns.total_fixed > 0) {
                                html += `<br><small class="text-success"><i class="fas fa-check"></i> ${vulns.total_fixed} fixed</small>`;
                            }
                            
                            return { html: html || '<span class="text-muted">No data</span>' };
                        }
                        
                        function formatDate(dateString) {
                            if (!dateString) return 'N/A';
                            const date = new Date(dateString);
                            return date.toLocaleDateString('en-US', { 
                                year: 'numeric', 
                                month: 'short', 
                                day: 'numeric' 
                            });
                        }
                        
                        function escapeHtml(text) {
                            const div = document.createElement('div');
                            div.textContent = text;
                            return div.innerHTML;
                        }
                        
                        function viewEngagementDetails(engagementId) {
                            // Navigate to engagement details page
                            window.open(`/engagement/${engagementId}/`, '_blank');
                        }
                        
                        function viewTeamDetails(teamMembers) {
                            alert(`Team Members:\n${teamMembers}`);
                        }
                        
                        function exportCompletedServices() {
                            alert('Preparing export...');
                        }
                        
                        function convertToCSV(services) {
                            const headers = [
                                'Service Name', 'Client', 'Service Type', 'Start Date', 'End Date', 
                                'Duration (Days)', 'Team Count', 'Team Members', 'Project Manager',
                                'Completion Status', 'Critical Vulns', 'High Vulns', 'Medium Vulns', 
                                'Low Vulns', 'Fixed Vulns', 'Remediation Rate'
                            ];
                            
                            const csvRows = [headers.join(',')];
                            
                            services.forEach(service => {
                                const row = [
                                    `"${service.name}"`,
                                    `"${service.client_name}"`,
                                    `"${service.service_type}"`,
                                    service.start_date,
                                    service.end_date,
                                    service.duration_days,
                                    service.team_count,
                                    `"${service.team_members_full.join(', ')}"`,
                                    `"${service.project_manager}"`,
                                    service.completion_status,
                                    service.vulnerabilities.critical_open,
                                    service.vulnerabilities.high_open,
                                    service.vulnerabilities.medium_open,
                                    service.vulnerabilities.low_open,
                                    service.vulnerabilities.total_fixed,
                                    service.remediation_rate
                                ];
                                csvRows.push(row.join(','));
                            });
                            
                            return csvRows.join('\n');
                        }
                        
                        function downloadCSV(csvData, filename) {
                            const blob = new Blob([csvData], { type: 'text/csv' });
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.setAttribute('hidden', '');
                            a.setAttribute('href', url);
                            a.setAttribute('download', filename);
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                        }

                    </script>
                    
                    <!-- Django data as JSON -->
                    {{ completed_services_details|json_script:"completed-services-data" }}
                    {{ grouped_services|json_script:"grouped-services-data" }}
                    <script>
                        // Get Django data safely
                        const completedServicesData = JSON.parse(document.getElementById('completed-services-data').textContent);
                        const groupedServicesData = JSON.parse(document.getElementById('grouped-services-data').textContent);
                        
                        // Update the modal functions to use the global data
                        function showCompletedServicesModalUpdated() {
                            const totalServices = {{ total_services|default:0 }};
                            const totalOpenVulns = {{ total_open_vulnerabilities|default:0 }};
                            const serviceTypes = {{ service_type_count|default:0 }};
                            const clientsServed = {{ total_unique_clients_served|default:0 }};
                            
                            // Get the date range from the form
                            const startDate = document.querySelector('input[name="start_date"]')?.value || '';
                            const endDate = document.querySelector('input[name="end_date"]')?.value || '';
                            const dateRangeText = startDate && endDate ? 
                                `${formatDate(startDate)} to ${formatDate(endDate)}` : 
                                'default period (past 3 months)';
                            
                            // Update modal content
                            document.getElementById('modalDateRange').textContent = dateRangeText;
                            document.getElementById('modalTotalServices').textContent = totalServices;
                            document.getElementById('modalOpenVulns').textContent = totalOpenVulns;
                            document.getElementById('modalServiceTypes').textContent = serviceTypes;
                            document.getElementById('modalClientsServed').textContent = clientsServed;
                            
                            // Show grouped view by default
                            showGroupedView();
                            
                            // Populate both tables
                            populateGroupedServicesTable(groupedServicesData);
                            populateServicesTable(completedServicesData);
                            
                            // Show the modal
                            $('#completedServicesModal').modal('show');
                        }
                        
                        // Override the original function
                        window.showCompletedServicesModal = showCompletedServicesModalUpdated;
                        
                        function exportCompletedServicesUpdated() {
                            // Basic CSV export functionality
                            if (!completedServicesData || completedServicesData.length === 0) {
                                alert('No services to export.');
                                return;
                            }
                            
                            const csvData = convertToCSV(completedServicesData);
                            downloadCSV(csvData, 'completed_services.csv');
                        }
                        
                        // Override the original function
                        window.exportCompletedServices = exportCompletedServicesUpdated;

                        // View Toggle Functions
                        function showGroupedView() {
                            document.getElementById('groupedServicesView').style.display = 'block';
                            document.getElementById('detailedServicesView').style.display = 'none';
                            document.getElementById('groupedViewBtn').classList.add('active');
                            document.getElementById('detailedViewBtn').classList.remove('active');
                        }

                        function showDetailedView() {
                            document.getElementById('groupedServicesView').style.display = 'none';
                            document.getElementById('detailedServicesView').style.display = 'block';
                            document.getElementById('groupedViewBtn').classList.remove('active');
                            document.getElementById('detailedViewBtn').classList.add('active');
                        }

                        // Populate Grouped Services Table
                        function populateGroupedServicesTable(groupedServices) {
                            const tableBody = document.getElementById('groupedServicesTableBody');
                            const noServicesMessage = document.getElementById('noServicesMessage');
                            
                            if (!groupedServices || groupedServices.length === 0) {
                                tableBody.innerHTML = '';
                                noServicesMessage.style.display = 'block';
                                return;
                            }

                            noServicesMessage.style.display = 'none';
                            let html = '';

                            groupedServices.forEach(service => {
                                const riskBadgeClass = getRiskBadgeClass(service.risk_level);
                                const completionBadgeClass = service.perfect_completion_rate >= 80 ? 'badge-success' : 
                                                           service.perfect_completion_rate >= 60 ? 'badge-warning' : 'badge-danger';
                                
                                html += `
                                    <tr onclick="toggleServiceDetails('service-${service.service_name.replace(/\s+/g, '-')}')" style="cursor: pointer;">
                                        <td>
                                            <strong>${service.service_name}</strong>
                                            <i class="fas fa-chevron-down ml-2 toggle-icon" data-target="service-${service.service_name.replace(/\s+/g, '-')}"></i>
                                        </td>
                                        <td><span class="badge badge-primary badge-pill">${service.completed_count}</span></td>
                                        <td>${service.unique_clients_count}</td>
                                        <td>${service.avg_duration_days} days</td>
                                        <td>${service.avg_team_size}</td>
                                        <td>
                                            <span class="badge ${completionBadgeClass}">${service.perfect_completion_rate}%</span>
                                        </td>
                                        <td>
                                            <span class="badge ${service.total_vulnerabilities_open > 0 ? 'badge-warning' : 'badge-success'}">
                                                ${service.total_vulnerabilities_open}
                                            </span>
                                            ${service.total_vulnerabilities_open > 0 ? `
                                                <br><small class="text-muted">
                                                    C:${service.vulnerability_breakdown.critical}
                                                    H:${service.vulnerability_breakdown.high}
                                                    M:${service.vulnerability_breakdown.medium}
                                                    L:${service.vulnerability_breakdown.low}
                                                </small>
                                            ` : ''}
                                        </td>
                                        <td><span class="badge ${riskBadgeClass}">${service.risk_level.toUpperCase()}</span></td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-info" onclick="event.stopPropagation(); showServiceEngagements('${service.service_name}')">
                                                <i class="fas fa-list"></i> View
                                            </button>
                                        </td>
                                    </tr>
                                    <tr id="service-${service.service_name.replace(/\s+/g, '-')}" class="service-details-row" style="display: none;">
                                        <td colspan="9" class="bg-light">
                                            <div class="p-3">
                                                <h6>Recent Engagements for ${service.service_name}:</h6>
                                                <div class="row">
                                                    ${service.engagements.slice(0, 3).map(eng => `
                                                        <div class="col-md-4">
                                                            <div class="card mb-2">
                                                                <div class="card-body py-2">
                                                                    <h6 class="card-title mb-1">${eng.name}</h6>
                                                                    <p class="card-text small mb-1">
                                                                        <strong>Client:</strong> ${eng.client_name}<br>
                                                                        <strong>Completed:</strong> ${formatDate(eng.end_date)}<br>
                                                                        <strong>Duration:</strong> ${eng.duration_days} days<br>
                                                                        <strong>Team Size:</strong> ${eng.team_size}<br>
                                                                        <strong>Open Vulns:</strong> ${eng.vulnerabilities_open}
                                                                    </p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                                ${service.engagements.length > 3 ? `
                                                    <button class="btn btn-sm btn-link p-0" onclick="showServiceEngagements('${service.service_name}')">
                                                        View all ${service.engagements.length} engagements â†’
                                                    </button>
                                                ` : ''}
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            });

                            tableBody.innerHTML = html;
                        }

                        // Helper function to get risk badge class
                        function getRiskBadgeClass(riskLevel) {
                            switch(riskLevel) {
                                case 'high': return 'badge-danger';
                                case 'medium': return 'badge-warning';
                                case 'low': return 'badge-info';
                                case 'none': return 'badge-success';
                                default: return 'badge-secondary';
                            }
                        }

                        // Toggle service details row
                        function toggleServiceDetails(targetId) {
                            const target = document.getElementById(targetId);
                            const icon = document.querySelector(`[data-target="${targetId}"]`);
                            
                            if (target.style.display === 'none' || !target.style.display) {
                                target.style.display = 'table-row';
                                icon.classList.remove('fa-chevron-down');
                                icon.classList.add('fa-chevron-up');
                            } else {
                                target.style.display = 'none';
                                icon.classList.remove('fa-chevron-up');
                                icon.classList.add('fa-chevron-down');
                            }
                        }

                        // Show all engagements for a specific service type
                        function showServiceEngagements(serviceTypeName) {
                            const serviceData = groupedServicesData.find(s => s.service_name === serviceTypeName);
                            if (!serviceData) return;

                            // Create a filtered services list for the detailed view
                            const filteredServices = completedServicesData.filter(s => s.service_type === serviceTypeName);
                            
                            // Switch to detailed view and populate with filtered data
                            showDetailedView();
                            populateServicesTable(filteredServices);
                            
                            // Update table header to show filter
                            const tableContainer = document.getElementById('detailedServicesView');
                            let filterInfo = tableContainer.querySelector('.filter-info');
                            if (!filterInfo) {
                                filterInfo = document.createElement('div');
                                filterInfo.className = 'filter-info alert alert-info mb-3';
                                tableContainer.insertBefore(filterInfo, tableContainer.firstChild);
                            }
                            filterInfo.innerHTML = `
                                <i class="fas fa-filter mr-2"></i>Showing engagements for: <strong>${serviceTypeName}</strong>
                                <button class="btn btn-sm btn-link ml-2" onclick="clearServiceFilter()">Clear Filter</button>
                            `;
                        }

                        // Clear service filter and show all services
                        function clearServiceFilter() {
                            const filterInfo = document.querySelector('.filter-info');
                            if (filterInfo) filterInfo.remove();
                            populateServicesTable(completedServicesData);
                        }
                    </script>

{% endblock %}