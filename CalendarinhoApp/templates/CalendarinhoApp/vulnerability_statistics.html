{% extends 'CalendarinhoApp/BaseNew.html' %}
{% load static %}

{% block head_block %}
<script src="{% static 'vendor/chart.js/Chart.bundle.js' %}"></script>
<style>
  .card-metric {
    display: flex; align-items: center; justify-content: space-between;
  }
  .metric-value { font-size: 1.75rem; font-weight: 800; }
  .metric-label { color: #6c757d; font-weight: 600; }
  .table-responsive { max-height: 60vh; }
  .select2-container { width: 100% !important; }
  /* Compact charts */
  .chart-card .card-body { padding: 0.75rem 1rem; }
  .chart-wrap { position: relative; height: 220px; }
  .chart-card canvas { width: 100% !important; height: 100% !important; }
  @media (max-width: 768px) {
    .chart-wrap { height: 180px; }
  }
  /* Sort indicators */
  #vuln-table thead th.sortable { position: relative; user-select: none; }
  #vuln-table thead th.sortable.sorted-asc::after { content: " \25B2"; font-size: 0.75rem; color: #6c757d; }
  #vuln-table thead th.sortable.sorted-desc::after { content: " \25BC"; font-size: 0.75rem; color: #6c757d; }
</style>
{% endblock %}

{% block body_block %}
<div class="container-fluid">
  <div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">Vulnerability Statistics</h1>
  </div>

  <!-- Global Filter -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row align-items-end">
        <div class="col-md-8">
          <label for="client-filter" class="mb-1">Filter by Clients</label>
          <select id="client-filter" class="form-control" multiple></select>
        </div>
        <div class="col-md-4 text-right">
          <button id="apply-filter" class="btn btn-primary">Apply</button>
          <button id="clear-filter" class="btn btn-secondary ml-2">Clear</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Metrics Cards -->
  <div class="row" id="metrics-cards">
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-primary shadow h-100 py-2">
        <div class="card-body card-metric">
          <div>
            <div class="metric-label">Total Vulnerabilities</div>
            <div id="metric-total" class="metric-value">-</div>
          </div>
          <i class="fas fa-bug fa-2x text-primary"></i>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-success shadow h-100 py-2">
        <div class="card-body card-metric">
          <div>
            <div class="metric-label">Closed / Fixed</div>
            <div id="metric-fixed" class="metric-value">-</div>
          </div>
          <i class="fas fa-check-circle fa-2x text-success"></i>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-danger shadow h-100 py-2">
        <div class="card-body card-metric">
          <div>
            <div class="metric-label">Open</div>
            <div id="metric-open" class="metric-value">-</div>
          </div>
          <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-left-warning shadow h-100 py-2">
        <div class="card-body card-metric">
          <div>
            <div class="metric-label">SLA Breaches</div>
            <div id="metric-overdue" class="metric-value">-</div>
          </div>
          <i class="fas fa-stopwatch fa-2x text-warning"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts -->
  <div class="row">
    <div class="col-xl-6 mb-4">
      <div class="card shadow chart-card">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
          <h6 class="m-0 font-weight-bold text-primary">Severity Breakdown</h6>
        </div>
        <div class="card-body">
          <div class="chart-wrap">
            <canvas id="severity-pie" aria-label="Severity Breakdown"></canvas>
          </div>
          <div id="severity-pie-empty" class="text-center text-muted small d-none mt-2">No data</div>
        </div>
      </div>
    </div>

    <div class="col-xl-6 mb-4">
      <div class="card shadow chart-card">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
          <h6 class="m-0 font-weight-bold text-primary">Status by Severity</h6>
        </div>
        <div class="card-body">
          <div class="chart-wrap">
            <canvas id="status-by-severity" aria-label="Status by Severity"></canvas>
          </div>
          <div id="status-by-severity-empty" class="text-center text-muted small d-none mt-2">No data</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Table -->
  <div class="card shadow mb-4">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
      <h6 class="m-0 font-weight-bold text-primary">Vulnerabilities</h6>
    </div>
    <div class="card-body">
      <div class="row mb-3">
        <div class="col-md-6">
          <div class="input-group">
            <input id="vuln-search" type="text" class="form-control" placeholder="Search title...">
            <div class="input-group-append">
              <button id="btn-search" class="btn btn-outline-primary" type="button">Search</button>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <select id="severity-filter" class="form-control">
            <option value="">All Severities</option>
            <option value="Critical">Critical</option>
            <option value="High">High</option>
            <option value="Medium">Medium</option>
            <option value="Low">Low</option>
          </select>
        </div>
        <div class="col-md-3 d-flex justify-content-end align-items-center">
          <div class="custom-control custom-switch m-0">
            <input type="checkbox" class="custom-control-input" id="toggle-hide-fixed">
            <label class="custom-control-label" for="toggle-hide-fixed">Hide Fixed</label>
          </div>
          <button id="btn-export" class="btn btn-outline-secondary ml-3">Export CSV</button>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-bordered table-striped table-hover" id="vuln-table">
          <thead class="thead-light">
            <tr>
              <th data-sort="title" class="sortable">Title</th>
              <th data-sort="severity" class="sortable">Severity</th>
              <th data-sort="status" class="sortable">Status</th>
              <th data-sort="engagement_name" class="sortable">Engagement</th>
              <th data-sort="client_name" class="sortable">Client</th>
              <th data-sort="created_at" class="sortable">Created</th>
              <th data-sort="expected_fix_date" class="sortable">Expected Fix</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div id="table-empty" class="text-center text-muted small d-none">No vulnerabilities found</div>
        <div id="pager" class="d-flex justify-content-between align-items-center mt-3">
          <div class="text-muted small" id="page-info"></div>
          <div class="d-flex align-items-center">
            <label for="per-page" class="mr-2 mb-0 small text-muted">Rows per page</label>
            <select id="per-page" class="form-control form-control-sm mr-3" style="width: auto;">
              <option value="10" selected>10</option>
              <option value="25">25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
            <ul class="pagination pagination-sm mb-0">
              <li class="page-item" id="btn-prev"><a class="page-link" href="#">Prev</a></li>
              <li class="page-item" id="btn-next"><a class="page-link" href="#">Next</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  const selectedClientIds = '{{ selected_client_ids|default:"" }}';

  // Populate clients list
  function loadClientOptions() {
    return fetch('{% url "CalendarinhoApp:api_filter_options" %}?type=engagements')
      .then(r => r.json())
      .then(data => {
        if (!data.success) return;
        const select = document.getElementById('client-filter');
        // Clear
        select.innerHTML = '';
        const clients = (data.options && data.options.clients) || [];
        clients.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.value;
          opt.textContent = c.label;
          select.appendChild(opt);
        });
        if (selectedClientIds) {
          const pre = selectedClientIds.split(',').filter(Boolean);
          for (const v of pre) {
            const o = [...select.options].find(x => String(x.value) === String(v));
            if (o) o.selected = true;
          }
        }
        try { $('#client-filter').select2(); } catch(e) {}
      })
      .catch(() => {});
  }

  let pieChart, stackedChart;
  function setMetrics(analytics) {
    const total = analytics.status_breakdown.open + analytics.status_breakdown.fixed;
    document.getElementById('metric-total').textContent = total;
    document.getElementById('metric-fixed').textContent = analytics.status_breakdown.fixed;
    document.getElementById('metric-open').textContent = analytics.status_breakdown.open;
    document.getElementById('metric-overdue').textContent = analytics.overdue_count;
  }

  function renderPie(analytics) {
    const ctx = document.getElementById('severity-pie').getContext('2d');
    const sev = analytics.severity_breakdown;
    const values = ['Critical','High','Medium','Low'].map(k => (sev[k].open + sev[k].fixed));
    const hasData = values.some(v => v > 0);
    document.getElementById('severity-pie-empty').classList.toggle('d-none', hasData);
    if (pieChart) pieChart.destroy();
    pieChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Critical','High','Medium','Low'],
        datasets: [{
          data: values,
          backgroundColor: ['#e74a3b','#f6c23e','#36b9cc','#1cc88a']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        legend: { position: 'bottom' },
        cutoutPercentage: 60,
        layout: { padding: { left: 10, right: 10, top: 10, bottom: 10 } }
      }
    });
  }

  function renderStacked(analytics) {
    const ctx = document.getElementById('status-by-severity').getContext('2d');
    const sev = analytics.severity_breakdown;
    const labels = ['Critical','High','Medium','Low'];
    const open = labels.map(k => sev[k].open);
    const fixed = labels.map(k => sev[k].fixed);
    const hasData = [...open, ...fixed].some(v => v > 0);
    document.getElementById('status-by-severity-empty').classList.toggle('d-none', hasData);
    if (stackedChart) stackedChart.destroy();
    stackedChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: 'open', backgroundColor: '#e74a3b', data: open },
          { label: 'closed', backgroundColor: '#1cc88a', data: fixed }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          xAxes: [{
            stacked: true,
            gridLines: { display: false },
            categoryPercentage: 0.6,
            barPercentage: 0.7
          }],
          yAxes: [{
            stacked: true,
            ticks: { beginAtZero: true, precision: 0 },
            gridLines: { color: 'rgba(0,0,0,0.05)' }
          }]
        },
        legend: { position: 'bottom' },
        tooltips: { mode: 'index', intersect: false },
        layout: { padding: { left: 10, right: 10, top: 10, bottom: 10 } }
      }
    });
  }

  function loadAnalytics() {
    const select = document.getElementById('client-filter');
    const sel = [...select.selectedOptions].map(o => o.value).join(',');
    const qs = sel ? ('?client_ids=' + encodeURIComponent(sel)) : '';
    return fetch('{% url "CalendarinhoApp:api_vulnerability_analytics" %}' + qs)
      .then(r => r.json())
      .then(({success, data}) => { if (success) { setMetrics(data); renderPie(data); renderStacked(data); } });
  }

  let currentPage = 1;
  let perPage = 10;

  function loadTable() {
    const select = document.getElementById('client-filter');
    const sel = [...select.selectedOptions].map(o => o.value).join(',');
    const base = '{% url "CalendarinhoApp:api_vulnerabilities_filtered" %}';
    const params = new URLSearchParams();
    if (sel) params.set('client_ids', sel);
    params.set('per_page', String(perPage));
    params.set('page', String(currentPage));
    if (document.getElementById('toggle-hide-fixed').checked) params.set('status', 'Open');
    const search = document.getElementById('vuln-search').value.trim();
    if (search) params.set('search_title', search);
    const sev = document.getElementById('severity-filter').value;
    if (sev) params.set('severity', sev);
    if (currentSort.key) {
      params.set('sort_by', currentSort.key);
      params.set('sort_order', currentSort.order);
    }
    const url = base + '?' + params.toString();
    const tbody = document.querySelector('#vuln-table tbody');
    tbody.innerHTML = '';
    return fetch(url).then(r => r.json()).then(({success, vulnerabilities, pagination}) => {
      if (!success) return;
      const empty = document.getElementById('table-empty');
      empty.classList.toggle('d-none', (vulnerabilities && vulnerabilities.length));
      for (const v of (vulnerabilities || [])) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${v.title}</td>
          <td><span class="badge badge-${v.severity_color}">${v.severity}</span></td>
          <td>${v.status}</td>
          <td><a href="/engagement/${v.engagement_id}/">${v.engagement_name}</a></td>
          <td><a href="/client/${v.client_id}/">${v.client_name}</a></td>
          <td>${(v.created_at || '').substring(0,10)}</td>
          <td>${v.expected_fix_date ? v.expected_fix_date : '-'}</td>
        `;
        tbody.appendChild(tr);
      }
      // Update pager
      if (pagination) {
        document.getElementById('page-info').textContent = `Page ${pagination.current_page} of ${pagination.total_pages} • ${pagination.total_items} items`;
        document.getElementById('btn-prev').classList.toggle('disabled', !pagination.has_previous);
        document.getElementById('btn-next').classList.toggle('disabled', !pagination.has_next);
        currentPage = pagination.current_page;
      }
    });
  }

  function applyFilter() { Promise.all([loadAnalytics(), loadTable()]); }

  document.getElementById('apply-filter').addEventListener('click', function(){ currentPage = 1; applyFilter(); });
  document.getElementById('toggle-hide-fixed').addEventListener('change', loadTable);
  document.getElementById('btn-search').addEventListener('click', loadTable);
  document.getElementById('vuln-search').addEventListener('keypress', function(e){ if(e.key==='Enter'){ loadTable(); }});
  document.getElementById('severity-filter').addEventListener('change', loadTable);

  // Sorting
  const currentSort = { key: '', order: 'asc' };
  document.querySelectorAll('#vuln-table thead th.sortable').forEach(th => {
    th.style.cursor = 'pointer';
    th.addEventListener('click', function(){
      const key = this.getAttribute('data-sort');
      if (currentSort.key === key) {
        currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.key = key;
        currentSort.order = 'asc';
      }
      document.querySelectorAll('#vuln-table thead th.sortable').forEach(el => el.classList.remove('sorted-asc','sorted-desc'));
      this.classList.add(currentSort.order === 'asc' ? 'sorted-asc' : 'sorted-desc');
      currentPage = 1;
      loadTable();
    });
  });

  // Export CSV (filtered rows)
  document.getElementById('btn-export').addEventListener('click', function(){
    const select = document.getElementById('client-filter');
    const sel = [...select.selectedOptions].map(o => o.value).join(',');
    const base = '{% url "CalendarinhoApp:api_vulnerabilities_filtered" %}';
    const params = new URLSearchParams();
    if (sel) params.set('client_ids', sel);
    params.set('per_page', '1000');
    const search = document.getElementById('vuln-search').value.trim();
    if (search) params.set('search_title', search);
    const sev = document.getElementById('severity-filter').value;
    if (sev) params.set('severity', sev);
    if (document.getElementById('toggle-hide-fixed').checked) params.set('status', 'Open');
    fetch(base + '?' + params.toString()).then(r=>r.json()).then(({success, vulnerabilities}) => {
      if (!success || !vulnerabilities || vulnerabilities.length === 0) return;
      const qs = new URLSearchParams();
      vulnerabilities.forEach(v => qs.append('ids', v.id));
      const link = document.createElement('a');
      link.href = '{% url "CalendarinhoApp:export_vulnerabilities" %}' + '?' + qs.toString();
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
  });
  document.getElementById('clear-filter').addEventListener('click', function(){
    const select = document.getElementById('client-filter');
    [...select.options].forEach(o => o.selected = false);
    try { $('#client-filter').trigger('change'); } catch(e) {}
    currentPage = 1; applyFilter();
  });

  // Pager controls
  document.getElementById('btn-prev').addEventListener('click', function(e){ e.preventDefault(); if (this.classList.contains('disabled')) return; currentPage = Math.max(1, currentPage - 1); loadTable(); });
  document.getElementById('btn-next').addEventListener('click', function(e){ e.preventDefault(); if (this.classList.contains('disabled')) return; currentPage = currentPage + 1; loadTable(); });
  document.getElementById('per-page').addEventListener('change', function(){ perPage = parseInt(this.value, 10) || 25; currentPage = 1; loadTable(); });

  loadClientOptions().then(applyFilter);
})();
</script>
{% endblock %}


